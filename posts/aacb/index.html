<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SPI接口及其应用 | 快乐星球</title><meta name="author" content="wxy"><meta name="copyright" content="wxy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="摘抄自王老师的电子书"><meta property="og:type" content="article"><meta property="og:title" content="SPI接口及其应用"><meta property="og:url" content="https://wxydejoy.top/posts/aacb/index.html"><meta property="og:site_name" content="快乐星球"><meta property="og:description" content="摘抄自王老师的电子书"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://image.wxydejoy.top/img/SPI2021-08-04-20-14-21.jpg"><meta property="article:published_time" content="2021-08-04T19:45:46.000Z"><meta property="article:modified_time" content="2021-09-11T10:01:08.958Z"><meta property="article:author" content="wxy"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://image.wxydejoy.top/img/SPI2021-08-04-20-14-21.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://wxydejoy.top/posts/aacb/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/pwa/manifest.json"><meta name="msapplication-TileColor" content="#fcfcfc"><link rel="apple-touch-icon" sizes="180x180" href="/img/icon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/icon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/icon/favicon-16x16.png"><link rel="mask-icon" href="/img/icon/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?030c10bdf13bb2cc37d4e87a1f483d74";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"来晚了，来晚了，吃不到热豆腐了，已经过了","messageNext":"天了，风化了。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":20,"languages":{"author":"作者: wxy","link":"链接: ","source":"来源: 快乐星球","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"SPI接口及其应用",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2021-09-11 10:01:08"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"><link rel="stylesheet" href="/css/bbindex.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper/lib/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper/lib/swiperstyle.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" media="print" onload='this.media="screen"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus/lib/tag_plugins.min.css" media="defer" onload='this.media="all"'><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/icon/android-chrome-96x96.png" onerror='onerror=null,src="/img/friend_404.webp"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">92</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-folder-open"></i> <span>归档</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-blind"></i> <span>时间</span></a></li><li><a class="site-page child" href="/statistics/"><i class="fa-fw fas fa-globe"></i> <span>统计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-coffee"></i> <span>生活</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%F0%9F%94%96-Life/"><i class="fa-fw fa fa-car"></i> <span>杂谈</span></a></li><li><a class="site-page child" href="/categories/%F0%9F%96%A5%EF%B8%8F-Software/"><i class="fa-fw fas fa-archive"></i> <span>软件</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-video"></i> <span>电影</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%F0%9F%93%BD%EF%B8%8F-Movies/"><i class="fa-fw fas fa-heart"></i> <span>影评</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-play"></i> <span>豆瓣</span></a></li><li><a class="site-page child" href="/bangumis/index.html"><i class="fa-fw fas fa-play"></i> <span>动漫</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-forward"></i> <span>学习</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%F0%9F%93%9A%EF%B8%8F-Study/"><i class="fa-fw fas fa-cog"></i> <span>课程</span></a></li><li><a class="site-page child" href="/categories/%F0%9F%92%BB-Teach/"><i class="fa-fw fas fa-th-list"></i> <span>教程</span></a></li><li><a class="site-page child" href="/categories/%F0%9F%92%BB-Code/"><i class="fa-fw fas fa-bolt"></i> <span>代码</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-random"></i> <span>其他</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/file/"><i class="fa-fw fas fa-file"></i> <span>文件</span></a></li><li><a class="site-page child" href="/hpp/"><i class="fa-fw fa fa-bed"></i> <span>一号树洞</span></a></li><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fa fa-bed"></i> <span>二号树洞</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw fa fa-bomb"></i> <span>三号树洞</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.weiciyun.com/"><i class="fa-fw fas fa-cog"></i> <span>封面制作</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://image.wxydejoy.top/img/202107/23/005622%201.html"><i class="fa-fw fas fa-cog"></i> <span>无聊点这</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://image.wxydejoy.top/img/202107/23/005627%202.html"><i class="fa-fw fas fa-cog"></i> <span>特效点这</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://wxydejoy.wxydejoy.workers.dev/hpp/admin/login"><i class="fa-fw fas fa-cog"></i> <span>HPP</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://image.wxydejoy.top/img/SPI2021-08-04-20-14-21.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">快乐星球</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-folder-open"></i> <span>归档</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-blind"></i> <span>时间</span></a></li><li><a class="site-page child" href="/statistics/"><i class="fa-fw fas fa-globe"></i> <span>统计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-coffee"></i> <span>生活</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%F0%9F%94%96-Life/"><i class="fa-fw fa fa-car"></i> <span>杂谈</span></a></li><li><a class="site-page child" href="/categories/%F0%9F%96%A5%EF%B8%8F-Software/"><i class="fa-fw fas fa-archive"></i> <span>软件</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-video"></i> <span>电影</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%F0%9F%93%BD%EF%B8%8F-Movies/"><i class="fa-fw fas fa-heart"></i> <span>影评</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-play"></i> <span>豆瓣</span></a></li><li><a class="site-page child" href="/bangumis/index.html"><i class="fa-fw fas fa-play"></i> <span>动漫</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-forward"></i> <span>学习</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%F0%9F%93%9A%EF%B8%8F-Study/"><i class="fa-fw fas fa-cog"></i> <span>课程</span></a></li><li><a class="site-page child" href="/categories/%F0%9F%92%BB-Teach/"><i class="fa-fw fas fa-th-list"></i> <span>教程</span></a></li><li><a class="site-page child" href="/categories/%F0%9F%92%BB-Code/"><i class="fa-fw fas fa-bolt"></i> <span>代码</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-random"></i> <span>其他</span><i class="fas fa-chevron-down expand hide"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/file/"><i class="fa-fw fas fa-file"></i> <span>文件</span></a></li><li><a class="site-page child" href="/hpp/"><i class="fa-fw fa fa-bed"></i> <span>一号树洞</span></a></li><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fa fa-bed"></i> <span>二号树洞</span></a></li><li><a class="site-page child" href="/bb/"><i class="fa-fw fa fa-bomb"></i> <span>三号树洞</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.weiciyun.com/"><i class="fa-fw fas fa-cog"></i> <span>封面制作</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://image.wxydejoy.top/img/202107/23/005622%201.html"><i class="fa-fw fas fa-cog"></i> <span>无聊点这</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://image.wxydejoy.top/img/202107/23/005627%202.html"><i class="fa-fw fas fa-cog"></i> <span>特效点这</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://wxydejoy.wxydejoy.workers.dev/hpp/admin/login"><i class="fa-fw fas fa-cog"></i> <span>HPP</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i> <span>关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SPI接口及其应用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-08-04T19:45:46.000Z" title="发表于 2021-08-04 19:45:46">2021-08-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-09-11T10:01:08.958Z" title="更新于 2021-09-11 10:01:08">2021-09-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%F0%9F%93%9A%EF%B8%8F-Study/">📚️ Study</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">18.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>66分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="SPI接口及其应用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img gist" style="background-image:url(https://image.wxydejoy.top/img/SPI2021-08-04-20-14-21.jpg)"></div><article class="post-content" id="article-container"><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><h1 id="第6章-SPI接口及其应用">================================<br>第6章 SPI接口及其应用<a class="header-anchor" href="#第6章-SPI接口及其应用"></a></h1><p>SPI(Serial Peripheral Interface)，即串行外设接口。SPI最早由Motolora半导体部门提出，最初出现在M68系列单片机上用于连接片外的EEPROM、ADC和DAC等外设。<br>SPI是一种伪共享的全双工/半双工的同步串行通讯接口，仅支持单主多从的系统结构。伪共享的总线结构是受到并行总线的影响，要求主机必须为每一个从机提供一个片选信号(CS)，<br>当某个从机的片选信号被主机置为有效电平时，主机和被选中的从机之间实现全双工/半双工的同步串行通讯。同步串行通讯，意味着SPI接口具有专用的同步时钟信号。<br>全双工，意味着SPI接口拥有独立的“主机写-从机读”和“主机读-从机写”串行数据传输线。半双工只需要一根串行数据线双向传输数据。</p><p>SPI接口经历多次改进，目前不仅支持单个串行数据信号，也支持2位和4位宽度的串行数据信号，在同样的时钟频率条件下串行数据线越多数据吞吐量越大。<br>QSPI(Quad SPI)接口的数据信号达4个，假设同步时钟信号的频率为32MHz，QSPI实际的位时钟频率达128MHz。高速的QSPI接口已经用于嵌入式系统内的大容量FlashROM、<br>伪静态RAM等存储器扩展，借助于MCU片上Cache单元甚至可以直接从QSPI接口的FlashROM中执行(XIP)程序。显然，SPI接口是嵌入式系统内十分重要的一种扩展接口，<br>与I2C接口一样，SPI也是绝大多数MCU标配的片上功能单元。</p><p>本章将了解SPI接口的信号、时序和协议规范，以及MCU片上SPI功能单元的主机模式和从机模式，并以SPI接口的显示器和协处理器、QSPI接口的FlashROM等为例讨论SPI接口的结构组成、接口电路和软件编程控制。</p><h1 id="6-1-SPI通讯接口">===========================<br>6.1 SPI通讯接口<a class="header-anchor" href="#6-1-SPI通讯接口"></a></h1><p>SPI通讯接口采用主从模式的结构，仅支持一个主机和一个或多个从机。标准的SPI通讯接口是4线的，包括同步时钟信号SCK、主输出从输入信号MOSI、主输入从输出信号MISO、<br>片选信号NSS(Slave Select)。一对SPI通讯接口的主机和从机的内部结构如图6.1所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-14-21.jpg" alt="SPI2021-08-04-20-14-21"></p><p>图6.1 SPI通讯接口的主机和从机内部结构</p><p>这里再次看到移位寄存器，他是SPI通讯接口的核心部组件。根据现代MCU的存储器映射规则，SPI通讯接口的接收和发送数据缓冲器都是MCU内部存储单元。<br>当SPI通讯接口软件将待发送的数据写入发送数据缓冲器并启动数据发送过程(片选信号NSS被主机置为有效电平)，该数据将被自动装载到移位寄存器，<br>并以最高位(MSB)先发送的规则随着同步时钟SCK顺序地将数据逐位从MOSI发出，同时从机SPI接口将随着同步时钟SCK逐位地将数据位移入移位寄存器。<br>当主机需要从从机读取数据时，从机首先将待发送的数据写入发送数据缓冲器，当主机将片选信号NSS置为有效电平时自动将数据加载到从机的移位寄存器，<br>随着同步时钟信号SCK仍遵循MSB先发送的规则将数据顺序地逐位从MISO发出，同时主机SPI接口将随着同步时钟SCK逐位地将数据移入移位寄存器，<br>所有数据位移入完毕后，主机移位寄存器的数据自动被加载到接收数据缓冲器。</p><p>这两个方向的移位过程是可以同时进行，而且不会有接收和发送数据位重叠，两个移位寄存器被两个独立的串行数据线首尾串联成环形，<br>譬如一个字节(8位)数据从主机移入从机的同时从机上的一个字节数据也正好移入主机。<br>很显然，标准的SPI通讯接口支持全双工数据传输，即主机向从机写入数据的同时可以读取从机上的数据。<br>事实上，为了提高数据传输效率，绝大多数现代SPI通讯接口的接收和发送数据缓冲器都采用FIFO(先进先出)结构、接收和发送完毕的中断机制。</p><p>有些SPI通讯接口的应用场景无需全双工的数据传输，譬如只需要半双工或单工，我们可以简化接口以减少信号线。图6.2给出全双工的和半双工的SPI通讯接口的对比。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-14-33.jpg" alt="SPI2021-08-04-20-14-33"></p><p>图6.2 全双工的和半双工的SPI通讯接口</p><p>很多资料中提到4线的和3线的SPI接口正是上图所示的两种情况，4线的是标准SPI通讯接口，3线的是半双工的SPI通讯接口。在半双工的数据传输模式，<br>主机的MOSI和从机的MISO相连，而且主从双方的这个接口信号都是双向的。为了防止信号名称的混淆，在上图中的主机侧仍使用NSS、SCK、MOSI和MISO等4个名称，<br>而从机侧则使用SDI(从机数据输入信号)代替MOSI，SDO(从机数据输出信号或数据输入信号)代替MISO。其中，半双工模式，从机的SDO信号是双向的，<br>主机的MOSI信号也是双向的。</p><p>半双工的SPI通讯接口节约一个接口信号连线，但并不是所有的SPI接口都支持半双工的模式。单工的SPI接口也可以节约一个接口信号，<br>根据数据传输的方向需要确定去掉MOSI或MISO。譬如显示器是一种典型的输出外设，显示器的SPI接口可以采用单工的，仅需要NSS、SCK和MOSI三个信号即可。</p><p>前面讨论的都是一主一从的SPI通讯接口，多从机时的SPI接口是什么样的结构呢？如图6.3所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-14-44.jpg" alt="SPI2021-08-04-20-14-44"></p><p>图6.3 一主多从的SPI通讯接口</p><p>上图中给出两种拓扑结构的一主多从的SPI通讯接口。图中(a)是常规的拓扑结构，SCK、MOSI和MISO等三个信号是SPI通讯接口的共享总线信号，<br>所有的主机和从机使用这些共享总线连接在一起，但是每一个从机必须独占一个片选信号NSS，随着从机个数的增加，主机将开销更多的I/O引脚用作片选信号。<br>很显然，图中(b)的菊花链拓扑结构中所需要主机的I/O引脚始终是4个，不受从机个数影响。对比两种拓扑，虽然菊花链结构节约I/O引脚但数据传输需要经过更多次移位，<br>即消耗更多个同步时钟周期，意味着更低的数据通讯速率。此外，两种拓扑结构的接口软件区别较大，菊花链结构的某个从机与主机之间传输数据所耗费的时钟个数必须根据从机个数和顺序号来确定。</p><p>后面所用的SPI通讯接口都默认为常规的拓扑，除非特别说明。与I2C通讯接口使用的惟一从机地址的寻址方法完全不同，任一SPI从机是否被选中与SPI主机通讯，<br>仅由其片选信号NSS的状态所决定。通常，SPI主机需要访问某个从机时，只需要将该从机的片选信号NSS置为有效电平，同时其他从机的片选信号都被置为无效电平，<br>仅有一个从机被选中与主机通讯。这种通过惟一的片选信号选中某个从机的方法与传统的三总线(数据总线、地址总线和控制总线)的片选信号选中某个外设的方法几乎完全一致，<br>传统的三总线是并行总线，现在仅适合MCU或MPU片上组件之间互联，主CPU通过控制地址译码器将某个组件的片选信号置为有效电平，此时主CPU与被选中的组件之间独占完整总线进行数据传输，<br>期间其他组件(即未被选中的组件)处于空闲状态。当某个SPI从机的片选信号被主机置为有效电平时，SPI主机与被选中的从机之间独占SPI接口总线进行数据传输，<br>其他未被选中的SPI从机处于空闲状态，忽略SPI总线的输入信号(SCK和MOSI)并释放输出信号(MISO)。</p><p>从SPI通讯接口的选中和非选中的访问方法看，任何时候仅有被选中的SPI从机与主机之间一对一通讯，因此SPI通讯接口的时序比I2C简单很多。如图6.4所示，<br>SPI通讯接口仅以8位(字节)及其整数倍的二进制位对齐的移位操作，没有I2C通讯接口的START和STOP等特殊时序。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-15-17.jpg" alt="SPI2021-08-04-20-15-17"></p><p>图6.4 SPI通讯接口的时序</p><p>上图中，SPI通讯接口的同步时钟信号SCK在总线空闲时的状态是低电平，并在SCK的第偶数次跳变沿对MOSI和MISO信号采样。事实上，标准的SPI接口规范中，<br>总线空闲时SCK信号的状态CPOL(Clock POLarity)、数据线的采样时刻CPHA(Clock PHAse)、位序MSBFIRST(先发送MSB)和SCK信号频率等都是可配置的。<br>这些配置也都是SPI软件接口的基本参数，详见第6.2节。关于CPOL和CPHA两个参数之间的关系如图6.5所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-15-26.jpg" alt="SPI2021-08-04-20-15-26"></p><p>图6.5 SPI通讯接口时序的4种配置</p><p>根据CPOL和CPHA两个参数，SPI通讯接口时序共有4种不同的配置模式。MODE0，SPI总线空闲时SCK保持低电平，当NSS信号有效期间，<br>SCK信号的第奇数次跳变沿采样MOSI和MISO信号，即SCK的上升沿时刻采样数据线。MODE2，SPI总线空闲时SCK保持高电平，当NSS信号有效期间，<br>SCK信号的第奇数次跳变沿采样MOSI和MISO信号，即SCK的下降沿时刻采样数据线。根据上图所示，MODE1和MODE3的两种配置无须赘述。</p><p>必须注意，数据线被采样的时刻必须确保数据线状态是稳定的，即不允许信号驱动端改变数据线状态，SPI通讯接口的每一种时序配置的数据线切换时刻也是确定的，<br>对于MODE0和MODE3的配置，允许SCK位低电平时改变MOSI和MISO的状态。</p><p>同步时钟信号SCK的频率是SPI通讯接口的波特率(Baudrate)，即二进制位的传输频率(或传输一个二进制位所消耗的时间)。当我们在配置SPI通讯接口的参数时，<br>必须考虑SPI从机的能力，包括SCK信号支持的/允许的最大频率、模式、位序等。换个角度来看待这些可配置参数，他们都是为了适应SPI从机的目的，<br>尤其是SPI从机是不可配置或不可编程的情况。</p><p>本质上，SPI通讯接口仅仅是一种同步串行数据移位操作的物理层接口，可配置接口参数的高灵活性和开源性使得SPI接口拥有很多种变化版本(Variant)。譬如，<br>当前被广泛使用于FlashROM(主要是NOR结构闪存)接口的2位(Dual)/4位(Quad)宽度的串行数据线版本分别称作DSPI和QSPI，接口时序的读写操作示例如图6.6所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-15-41.jpg" alt="SPI2021-08-04-20-15-41"></p><p>图6.6 DSPI和QSPI通讯接口的读写时序</p><p>上图中的SPI通讯接口配置参数采用MODE0。可以看出，为兼容标准4线SPI通讯接口，传输命令期间仍使用标准4线SPI接口时序，其后的地址和数据传输采用2位或4位宽度的串行数据线发送数据。<br>很显然，DSPI和QSPI的波特率分别是标准SPI通讯接口波特率的2倍和4倍。</p><p>上图©是先写命令和地址信息然后再顺序地连续读取若干地址单元的数据的时序，该时序的写入和读出操作之间有4个SCK周期的Dummy(占位)，<br>允许SPI从机在这个期间加载数据到发送缓冲区。DSPI和QSPI通讯接口的主机和从机信号如图6.7所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-15-54.jpg" alt="SPI2021-08-04-20-15-54"></p><p>图6.7 DSPI和QSPI通讯接口的主从信号</p><p>DSPI和QSPI通讯接口及其应用详见 [2]_ 页面的介绍。</p><p>SD卡是一种NAND结构的大容量闪存，TF卡是外型尺寸更小的SD卡(即micro SD)。SD卡接口不仅兼容标准SPI接口，也有专用的SD卡接口规范。<br>当SD卡的读写速度要求较低的场合，尤其嵌入式系统中可以使用标准SPI接口访问SD卡。即使SD卡的高速读写系统，SD卡上电后的初始化阶段，<br>主机使用标准SPI接口向SD卡发送配置命令，然后SD卡根据配置命令进入SD卡接口模式实现高带宽的数据读写操作。有关SD卡的SPI模式详见文档 [1]_<br>的第7章。SD卡、TF卡接口信号与SPI接口信号之间的关系如图6.8所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-16-05.jpg" alt="SPI2021-08-04-20-16-05"></p><p>图6.8 SD卡、TF卡接口信号与SPI接口信号之间关系</p><p>SD卡模式使用6个信号，分别为CMD、SCK、DAT0~3。4位宽度的串行数据线DAT0~3是双向的，与QSPI相同。CMD是传输主机命令和SD卡应答信息的专用信号线，<br>SD卡操作总是以命令帧(由1个字节命令、4个字节命令参数和1个字节CRC7校验和组成)开始，譬如CMD17和CMD24分别是单个数据块的读和写命令。</p><p>SDIO(Secure Digital Input and Output)接口是从SD接口衍生出来的一种高吞吐量的外设接口，向下兼容SD卡接口规范和标准SPI接口。<br>SDIO接口不仅用于可插拔的存储卡，还用于WiFi无线网卡、蓝牙卡、摄像头、GPS等外设接口。SDIO的具体应用和规范可在页面 [3]_ 找到。</p><p>更多的SPI通讯接口的变种，请查阅维基百科的SPI说明(<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface">https://en.wikipedia.org/wiki/Serial_Peripheral_Interface</a>)，如果无法打开该链接，<br>请点击下面的链接下载PDF格式的文档：</p><p>. :download:<code>维基百科(wikipedia.org)对SPI通讯接口的介绍 &lt;../_static/dl_files/bluefi_ch6_1/Serial_Peripheral_Interface_Wikipedia.pdf&gt;</code></p><p>前面已初步了解半双工SPI接口(3线)、全双工的标准SPI接口(4线)、DSPI(4线)、QSPI(6线)、SD(6线)及其衍生的SDIO等通讯接口，<br>这些接口常用于嵌入式系统主控制器与内部组件之间的总线接口，与I2C相比SPI接口的时序更简单、更容易实现、允许更高的波特率。</p><hr><p>BlueFi开源板的主控制器与彩色LCD显示器、WiFi协处理器等都使用SPI通讯接口，并使用QSPI接口扩展片外的2MB闪存用于保存Python库、<br>Python脚本程序、声音和图片等资源文件。此外，BlueFi开源板的40P金手指扩展接口的P13~P16可作为标准SPI接口。<br>BlueFi开源板的SPI接口如图6.9所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-16-20.jpg" alt="SPI2021-08-04-20-16-20"></p><p>图6.9 BlueFi开源板上的SPI接口外设</p><p>nRF52840具有1个QSPI接口和4个标准SPI接口(分别称作SPI0~3)，其中SPI0和SPI1分别与I2C0和I2C1共享存储器映射资源，即使用I2C0时SPI0将无法使用，<br>使用I2C1时将无法使用SPI1。nRF52840的4个标准SPI接口都可编程作为SPI主机模式，其中3个还可编程作为SPI从机模式。<br>此外，nRF52840的QSPI接口和4个标准SPI接口的最大波特率都高达32MHz。</p><p>根据上图可以看出，BlueFi开源板的彩色LCD显示器使用的是变种的SPI通讯接口，WiFi网络协处理器使用标准SPI接口，我们并未使用SPI支持的共享总线。<br>考虑到I2C0、I2C1和SPI0、SPI1共享存储器资源的局限性，我们在后续的BlueFi开源板的BSP代码中使用SPI2和SPI3分别连接彩色LCD显示器和WiFi网络协处理器，<br>前一章中我们已经使用I2C1作为BlueFi板上的温湿度、光学和运动传感器，BlueFi板的40P金手指扩展接口上的I2C和SPI接口分别使用I2C0和SPI0，<br>意味着任何时候只能选择使用其中的一种接口。</p><p>BlueFi开源板的QSPI接口固定用于片外2MB闪存的扩展接口，按照nRF52840的QSPI接口协议，最大支持24位地址宽度，即支持最大16MB片外扩展的QSPI闪存。<br>当然，根据QSPI接口规范，向下兼容DSPI和标准SPI等低速接口。BlueFi的片外2MB闪存主要用于Python文件系统，我们不再详细赘述</p><p>下一节将以BlueFi开源板的彩色LCD显示器的BSP实现为实例来了解SPI主机模式接口及其编程控制。</p><hr><p>参考文献：<br>::</p><p>[1] <a target="_blank" rel="noopener" href="https://www.sdcard.org/downloads/pls/click.php?p=Part1_Physical_Layer_Simplified_Specification_Ver8.00.jpg&amp;f=Part1_Physical_Layer_Simplified_Specification_Ver8.00.pdf&amp;e=EN_SS1_8">https://www.sdcard.org/downloads/pls/click.php?p=Part1_Physical_Layer_Simplified_Specification_Ver8.00.jpg&amp;f=Part1_Physical_Layer_Simplified_Specification_Ver8.00.pdf&amp;e=EN_SS1_8</a><br>[2] <a target="_blank" rel="noopener" href="https://www.nxp.com/docs/en/application-note/AN4512.pdf">https://www.nxp.com/docs/en/application-note/AN4512.pdf</a><br>[3] <a target="_blank" rel="noopener" href="https://www.sdcard.org/chs/index.html">https://www.sdcard.org/chs/index.html</a></p><h1 id="6-2-SPI主机模式">===========================<br>6.2 SPI主机模式<a class="header-anchor" href="#6-2-SPI主机模式"></a></h1><p>BlueFi开源板的彩色LCD显示器使用SPI通讯接口与nRF52840主控制器连接，显示器作为一种输出外设，我们将这个接口设计为半双工模式，<br>仅使用NSS、SCK、MOSI等三个信号，同时引入第4个信号——数据/命令信号D/C，当MOSI输出命令信息时D/C信号为低电平，输出数据时则为高电平。<br>引入D/C信号的SPI通讯接口的时序示例如图6.10所示。nRF52840的SPI通讯接口的主机模式支持D/C信号，每次发起SPI数据帧传输之前，<br>通过配置数据帧中的命令字节数和数据字节数，SPI接口自动产生D/C信号的有效电平向SPI从机发送数据/指令标示信号。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-16-42.jpg" alt="SPI2021-08-04-20-16-42"></p><p>图6.10 带有D/C信号的SPI通讯接口时序示例</p><p>BlueFi使用的彩色LCD显示器的驱动器为台湾矽创电子股份公司的ST7789V，支持262K(18位RGB颜色编码)种像素颜色，最大像素数达240x320。<br>ST7789支持可配置的多种并行与同步串行通讯接口，包括8-/9-/16-/18-位并行接口、3线(无D/C信号)和4线(有D/C信号)SPI接口。<br>我们使用的彩色LCD显示器由屏幕生产厂商将驱动IC、LCD玻璃屏、背光板等集成在一起，使用COG(Chip On Glass)工艺将驱动IC直接绑定在玻璃上，<br>同时驱动IC的接口配置也被设定。</p><p>BlueFi开源板使用的彩色LCD显示器及其接口电路如图6.11所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-16-58.jpg" alt="SPI2021-08-04-20-16-58"></p><p>图6.11 BlueFi开源板使用的彩色显示器及其接口电路</p><p>上图(a)的彩色LCD显示器示意图中浅灰色方形区是有效显示区域，右侧较宽的区域是COG工艺区和外部软排线接口区，实际使用时我们将软排线弯曲后焊在玻璃屏背面。<br>上图(b)的接口电路采用4线(含D/C信号)的半双工SPI接口，MOSI信号是双向的，这个接口电路中nRF52840的SPI通讯接口是主机模式，SCK和D/C两个信号的方向是输出。<br>此外，彩色LCD显示器作为一种非主动光源型显示器必须借助外界光源我们才能看到显示内容，背光板是此类显示器的必备组件，上图(b)的接口电路使用一个N型三极管控制背光板，<br>主控制器不仅能够控制背光板的亮、灭和亮度，还能提高背光板所需的大电流(约10mA)。</p><p>简要分析BlueFi开源板的彩色显示器接口电路后，接着开始了解该显示器的软件接口的实现。SPI接口软件也可以使用前一章所掌握的I2C的分层抽象方法，<br>硬件层仍使用Nordic半导体提供的SPI硬件驱动库，硬件抽象层则是Arduino开源平台的SPI类接口库，BlueFi的彩色LCD显示器接口软件(BSP)是基于硬件抽象层的实现(中间层)，<br>这部分BSP为用户层提供显示器初始化、文本和图形等显示接口。整个显示器接口软件的架构如图6.12所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-17-13.jpg" alt="SPI2021-08-04-20-17-13"></p><p>图6.12 基于SPI接口的彩色LCD显示器的软件架构(兼容Arduino平台)</p><p>在Arduino开源平台，对于任一种Arduino官方或第三方开源板系列，SPI通讯接口的硬件层和硬件抽象层的软件实现都是开源软件包的一部分。譬如，<br>基于Nordic的nRF52系列MCU的开源板，我们在第3.5节安装的nRF52系列MCU的开源软件包中，SPI通讯接口的硬件抽象层的软件实现位于<br>“…/Arduino15/packages/adafruit/hardware/nrf52/版本号/libraries/SPI/”文件夹，硬件层的软件实现由Nordic半导体提供，<br>位于“…/Arduino15/packages/adafruit/hardware/nrf52/版本号/cores/nRF5/nordic/nrfx/”文件夹。</p><p>Arduino官网列出SPI通讯接口的硬件抽象层的软件接口 [2]_ ，可以看出这个硬件抽象层仅支持SPI主机模式！主要接口包括：</p><ul><li>SPISettings(clock, borOrder, dataMode)，SPI通讯接口的SCK频率、位序和数据线采样模式等参数配置接口</li><li>setBitOrder(MSBFIRST)，SPI通讯接口的位序单独地配置接口：MSBFIRST和LSBFIRST等2种参数</li><li>setClockDivider(diver)，SPI通讯接口的时钟分频器配置接口。该配置将影响SCK时钟频率，CPU内核时钟频率被分频后作为SCK的时钟</li><li>setDataMode(mode)，SPI通讯接口的数据线采样模式单独地配置接口：SPI_MODE0、SPI_MODE1、SPI_MODE2、SPI_MODE3等4种参数</li><li>begin()，初始化SPI通讯接口，并配置为主机模式，并配置SPI通讯接口的引脚、时钟速度、位序、数据线采样模式等</li><li>end()，取消SPI通讯接口的初始化，禁用该SPI接口</li><li>beginTransaction(SPISettings)，使用SPISettings接口的参数初始化SPI通讯接口</li><li>endTransaction()，停用SPI通讯接口</li><li>transfer(txBuf[], rxBuf[], len)，SPI通讯接口的(全双工)数据传输接口。该接口有另外三种形式：transfer(val)、transfer(val16)、transfer(buf[], len)</li><li>usingInterrupt(numIRQ)，指定SPI通讯接口的中断号</li></ul><p>除了参数配置和初始化接口之外，全双工数据传输接口“transfer(txBuf[], rxBuf[], len)”是最基本的接口，另外三种形式的“transfer()”(半双工)接口也是基于该接口。<br>BlueFi开源板的彩色LCD显示器的BSP几乎仅仅使用Arduino开源平台SPI抽象层的“transfer()”接口，并根据该LCD的驱动器IC——ST7789V的接口规范(含命令和数据格式)，<br>首先定义“tft_Write_x(d)”、“pushPixels(colors[], len)”、“pushBlock(color, len)”等3个LCD基本的中间层接口，<br>分别实现8/16/24/32位数据写操作、连续写入若干个像素点的颜色值、连续填充(写入)若干像素位指定的颜色；基于这些基本的写入操作，接着定义单个像素(指定(x,y)坐标)颜色、<br>绘制直线、绘制圆弧和圆等基本图形图案的显示操作，以及彩色文本显示(指定位置和字体)等。</p><p>基于BSP(中间层)的LCD接口，我们很容易将文本信息显示在BlueFi的彩色LCD显示器上，或者基于直线、圆弧和圆等基本图形的绘制接口实现复杂图案设计与显示。<br>现在看起来LCD接口的功能较多，编写代码的工作量比较大。实施这些编码工作，我们无须从零开始，从“github”等开源社区的代码托管平台搜索“Arduino SPI ST7789”等关键词，<br>或许会找到数十甚至上百个相关的开源项目代码，直接将合适的项目代码移植到我们的项目中即可。</p><p>我们已经修改“Adafruit TFT eSPI”开源项目的代码用于BlueFi开源板，点击下面链接下载这部分代码的独立压缩包：</p><p>. :download:<code>BlueFi_TFT_eSPI开源库 &lt;../_static/dl_files/bluefi_ch6_2/BlueFi_TFT_eSPI.zip&gt;</code></p><p>请将下载后的压缩包文件解压到“…/Documents/Arduino/libraries/”文件夹，你将会看到“BlueFi_TFT_eSPI”子文件夹中的LCD显示器的全部接口。<br>面向用户层的接口都在“…/Documents/Arduino/libraries/BlueFi_TFT_eSPI/BlueFi_TFT_eSPI.h”文件中，只需要将该文件“include”到BlueFi开源板BSP的“BlueFi.h”文件并添加少许代码即可使用这些接口。<br>打开“…/Documents/Arduino/libraries/BlueFi/src/”文件夹中的“BlueFi.h”和“BlueFi.cpp”两个文件，将</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;BlueFi_TFT_eSPI.h&gt;</span> </span><br>TFT_eSPI Lcd = TFT_eSPI();<br></code></pre></td></tr></table></figure><p>两个语句添加到“BlueFi.h”文件中，并将下面的程序语句添加到“BlueFi.cpp”文件中的“void BlueFi::begin(bool LCDEnable, bool SerialEnable)”接口函数中：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-keyword">if</span> (LCDEnable) &#123;<br>  Lcd.init();<br>  Lcd.setRotation(<span class="hljs-number">1</span>);<br>  Lcd.fillScreen(TFT_BLACK); <span class="hljs-comment">// clear screen</span><br>  Lcd.setCursor(<span class="hljs-number">6</span>, <span class="hljs-number">108</span>, <span class="hljs-number">4</span>);<br>  Lcd.setTextColor(TFT_RED, TFT_BLACK);<br>  Lcd.print(<span class="hljs-string">&quot;BlueFi &quot;</span>); <span class="hljs-comment">// red</span><br>  Lcd.setTextColor(TFT_GREEN, TFT_BLACK);<br>  Lcd.print(<span class="hljs-string">&quot; with &quot;</span>); <span class="hljs-comment">// green</span><br>  Lcd.setTextColor(TFT_BLUE, TFT_BLACK);<br>  Lcd.print(<span class="hljs-string">&quot; Arduino\n&quot;</span>); <span class="hljs-comment">// blue, &quot;\n&quot;, to skip a line</span><br>  Lcd.setTextColor(TFT_WHITE, TFT_BLACK);<br>&#125;<br></code></pre></td></tr></table></figure><p>这些代码是对BlueFi开源板的彩色LCD显示器初始化的操作，包括屏幕旋转、清屏和默认的内容显示等。</p><p>为了便于测试，请先删除“…/Documents/Arduino/libraries/BlueFi”文件夹中的全部文件，然后下载下面的压缩文件包，<br>并解压到“…/Documents/Arduino/libraries/BlueFi”文件夹中，</p><p>. :download:<code>本节内容所用到的BlueFi的BSP源文件 &lt;../_static/dl_files/bluefi_ch6_2/BlueFi_bsp_ch6_2.zip&gt;</code></p><p>在这个BSP文件压缩包中已包含BlueFi开源板的彩色LCD显示器的BSP(中间层)接口，下面我们使用这些接口使用BlueFi的显示器。<br>示例1的源程序如下：</p><p>(…/examples/TFT_LCD/hello_world.ino)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;BlueFi.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>&#123;<br>  bluefi.begin();  <span class="hljs-comment">// 包含LCD显示器的初始化操作</span><br>  bluefi.Lcd.fillScreen(TFT_BLACK); <span class="hljs-comment">// 清屏，清除默认的显示内容</span><br>  <br>  <span class="hljs-comment">// Set &quot;cursor&quot; at top left corner of display (0,0) and select font 4</span><br>  bluefi.Lcd.setCursor(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br><br>  <span class="hljs-comment">// Set the font colour to be white with a black background</span><br>  bluefi.Lcd.setTextColor(TFT_WHITE, TFT_BLACK);<br>  <span class="hljs-comment">// We can now plot text on screen using the &quot;print&quot; class</span><br>  bluefi.Lcd.println(<span class="hljs-string">&quot;Hello, I am BlueFi\n&quot;</span>); <span class="hljs-comment">// &quot;\n&quot;, to skip a line</span><br><br>  bluefi.Lcd.setTextColor(TFT_WHITE, TFT_BLACK);<br>  bluefi.Lcd.println(<span class="hljs-string">&quot;this is White text&quot;</span>);<br>  bluefi.Lcd.setTextColor(TFT_RED, TFT_BLACK);<br>  bluefi.Lcd.println(<span class="hljs-string">&quot;this is Red text&quot;</span>);<br>  bluefi.Lcd.setTextColor(TFT_GREEN, TFT_BLACK);<br>  bluefi.Lcd.println(<span class="hljs-string">&quot;this is Green text&quot;</span>);<br>  bluefi.Lcd.setTextColor(TFT_BLUE, TFT_BLACK);<br>  bluefi.Lcd.println(<span class="hljs-string">&quot;this is Blue text&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>&#123;<br>  bluefi.redLED.on();<br>  delay(<span class="hljs-number">100</span>);<br>  bluefi.redLED.off();<br>  delay(<span class="hljs-number">900</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>这个示例中，首先调用“bluefi.begin()”对BlueFi开源板的相关硬件进行初始化，包括LCD显示器的初始化在内；然后调整显示器的光标位置和所用字体大小，<br>之后的显示将从当前光标位置开始；接着在屏幕上显示4行彩色文本信息，每一行文字的颜色分别位白色、红色、绿色和蓝色，用这些文本内容和颜色验证显示器的基本配置是否正确。<br>在主循环中不再更新显示内容，仅仅保持BlueFi开源板的红色LED闪烁，表示我们的程序已经正确地执行。</p><p>显然，借助于BlueFi开源板的中间层LCD接口让BlueFi的LCD显示彩色文本，我们并不需要直接访问SPI接口相关的寄存器，也无须直接面对LCD驱动IC——ST7789V的SPI通讯协议。<br>现在你可以打开“…/Documents/Arduino/libraries/BlueFi_TFT_eSPI/BlueFi_TFT_eSPI.h”文件了解我们的彩色LCD显示器接口的名称、参数等，<br>基于这些接口，我们可以实现各种显示效果。</p><p>下面我们来探索另外一个有趣的示例——康威生命游戏的模拟效果(取消gif格式动画)，如图6.13所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-17-27.jpg" alt="SPI2021-08-04-20-17-27"></p><p>图6.13 康威(Conway)生命游戏的模拟</p><p>该游戏由英国数学家康威(Conway)于1970年设计的，使用2D网格模拟生物群落的生与死，每一个网格代表一个生命体(或元胞)，其生存法则为：</p><ol><li>如果当前网格的元胞是活体，且周围活着的邻居数目(至多8个)为2个或3个时，保持原状态</li><li>如果当前网格的元胞是活体，且周围活着的邻居数目小于2个时，生物群落太小，该元胞死亡</li><li>如果当前网格的元胞是活体，且周围活着的邻居数目大于3个时，生物群落太大，该元胞死亡</li><li>如果当前网格的元胞是死亡的，且周围活着的邻居数目是3个，该元胞变为活体</li><li>如果当前网格的元胞是死亡的，且周围活着的邻居数目不是3个，保持原状态</li></ol><p>这些生存法则是经过我们重新编辑的描述，目的是更容易演变成生命游戏的程序算法。<br>该示例程序主要使用BlueFi的绘制填充颜色的方形图案的接口“fillRect(x, y, w, h, color)”绘制每个“细胞”的生与死状态，<br>如果某个网格的“细胞”为死亡状态则保持该方形图案的颜色与背景的黑色相同，否则随机选择一种非黑的颜色显示该“细胞”。示例程序的源码如下：</p><p>(…/examples/TFT_LCD/game_life.ino)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-comment">// //The Game of Life, also known simply as Life, is a Cellular Automaton</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;BlueFi.h&gt;</span> </span><br><span class="hljs-comment">// 2 x 2 pixel cells, array size = 28800 bytes per array, runs fast</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GRIDX 120</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GRIDY 120</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CELLXY 2</span><br><span class="hljs-comment">// 1 x 1 pixel cells, array size = 20480 bytes per array</span><br><span class="hljs-comment">//#define GRIDX 240</span><br><span class="hljs-comment">//#define GRIDY 240</span><br><span class="hljs-comment">//#define CELLXY 1</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GEN_DELAY 10 <span class="hljs-comment">// Set a delay between each generation to slow things down</span></span><br><span class="hljs-comment">//Current grid and newgrid arrays are needed</span><br><span class="hljs-keyword">uint8_t</span> grid[GRIDX][GRIDY];<br><span class="hljs-comment">//The new grid for the next generation</span><br><span class="hljs-keyword">uint8_t</span> newgrid[GRIDX][GRIDY];<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span>   </span>&#123;<br>  bluefi.begin();<br>  bluefi.Lcd.fillScreen(TFT_BLACK); <br>  initGrid();<br>  drawGrid();<br>  <span class="hljs-comment">//Compute generations then show</span><br>  <span class="hljs-keyword">uint16_t</span> generations = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> ( computeCA() ) &#123;<br>    generations++;<br>    Serial.print(<span class="hljs-string">&quot;Generations: &quot;</span>); Serial.println(generations);<br>    drawGrid(); <span class="hljs-comment">// show</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int16_t</span> x = <span class="hljs-number">1</span>; x &lt; GRIDX<span class="hljs-number">-1</span>; x++) &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int16_t</span> y = <span class="hljs-number">1</span>; y &lt; GRIDY<span class="hljs-number">-1</span>; y++) &#123;<br>        grid[x][y] = newgrid[x][y];<br>      &#125;<br>    &#125;<br>    delay(GEN_DELAY);<br>  &#125;<br>  bluefi.Lcd.setCursor(<span class="hljs-number">0</span>, <span class="hljs-number">120</span>, <span class="hljs-number">4</span>);<br>  bluefi.Lcd.setTextColor(TFT_WHITE, TFT_BLACK);<br>  bluefi.Lcd.println(<span class="hljs-string">&quot;Game over!&quot;</span>); <span class="hljs-comment">// &quot;\n&quot;, to skip a line</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>&#123;<br>&#125;<br><br><span class="hljs-comment">//Draws the grid on the display</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">drawGrid</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>  <span class="hljs-keyword">uint16_t</span> color = TFT_RED;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int16_t</span> x = <span class="hljs-number">1</span>; x &lt; GRIDX - <span class="hljs-number">1</span>; x++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int16_t</span> y = <span class="hljs-number">1</span>; y &lt; GRIDY - <span class="hljs-number">1</span>; y++) &#123;<br>      <span class="hljs-keyword">if</span> ((grid[x][y]) != (newgrid[x][y])) &#123;<br>        <span class="hljs-keyword">if</span> (newgrid[x][y] == <span class="hljs-number">1</span>)<br>          color = random(<span class="hljs-number">0xFFFF</span>);<br>        <span class="hljs-keyword">else</span><br>          color = <span class="hljs-number">0</span>;<br>        bluefi.Lcd.fillRect(CELLXY * x, CELLXY * y, CELLXY, CELLXY, color);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">//Initialise Grid</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">initGrid</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>&#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int16_t</span> x = <span class="hljs-number">0</span>; x &lt; GRIDX; x++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int16_t</span> y = <span class="hljs-number">0</span>; y &lt; GRIDY; y++) &#123;<br>      newgrid[x][y] = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> (x == <span class="hljs-number">0</span> || x == GRIDX - <span class="hljs-number">1</span> || y == <span class="hljs-number">0</span> || y == GRIDY - <span class="hljs-number">1</span>) &#123;<br>        grid[x][y] = <span class="hljs-number">0</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (random(<span class="hljs-number">3</span>) == <span class="hljs-number">1</span>)<br>          grid[x][y] = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">else</span><br>          grid[x][y] = <span class="hljs-number">0</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">//Compute the CA. Basically everything related to CA starts here</span><br><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">computeCA</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">bool</span> changed = <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int16_t</span> x = <span class="hljs-number">1</span>; x &lt; GRIDX; x++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int16_t</span> y = <span class="hljs-number">1</span>; y &lt; GRIDY; y++) &#123;<br>      <span class="hljs-keyword">uint8_t</span> neighbors = getNumberOfNeighbors(x, y);<br>      <span class="hljs-keyword">if</span> ( grid[x][y] == <span class="hljs-number">1</span> ) &#123;<br>        <span class="hljs-keyword">if</span> (neighbors != <span class="hljs-number">2</span> &amp;&amp; neighbors != <span class="hljs-number">3</span> ) &#123;<br>          newgrid[x][y] = <span class="hljs-number">0</span>; <span class="hljs-comment">// </span><br>          changed |= <span class="hljs-literal">true</span>;<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> ( neighbors == <span class="hljs-number">3</span> ) &#123;<br>          newgrid[x][y] = <span class="hljs-number">1</span>; <span class="hljs-comment">// Invert it (to live)</span><br>          changed |= <span class="hljs-literal">true</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> changed;<br>&#125;<br><br><span class="hljs-comment">// Check the Moore neighborhood</span><br><span class="hljs-function"><span class="hljs-keyword">uint8_t</span> <span class="hljs-title">getNumberOfNeighbors</span><span class="hljs-params">(<span class="hljs-keyword">int16_t</span> x, <span class="hljs-keyword">int16_t</span> y)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> grid[x<span class="hljs-number">-1</span>][y] + grid[x<span class="hljs-number">-1</span>][y<span class="hljs-number">-1</span>] + \<br>        grid[x][y<span class="hljs-number">-1</span>] + grid[x+<span class="hljs-number">1</span>][y<span class="hljs-number">-1</span>] + \<br>        grid[x+<span class="hljs-number">1</span>][y] + grid[x+<span class="hljs-number">1</span>][y+<span class="hljs-number">1</span>] + \<br>        grid[x][y+<span class="hljs-number">1</span>] + grid[x<span class="hljs-number">-1</span>][y+<span class="hljs-number">1</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>这个示例程序仅初始化“setup()”的代码，主循环“loop()”部分无代码(仅仅是一个死循环)。<br>初始化“setup()”的代码包括，BlueFi相关的接口和硬件初始化，并清除LCD屏幕、调用“initGrid()”和“drawGrid()”两个函数在显示屏上输出第一代“细胞”的模拟效果；<br>然后设置代表生存代数的变量generations为0，调用函数“computeCA()”根据生存法则计算每一个网格中“细胞”的生与死的状态，如果没有任何“细胞”的状态变化该函数返回false，<br>否则返回true；如果函数“computeCA()”的返回值为true则将当前的生存代数变量generations增加1并发送到串口控制台，调用函数“drawGrid()”绘制新一代的“细胞”状态，<br>并将保存此代的状态，延迟若干ms后再次调用函数“computeCA()”；如果函数“computeCA()”的返回值为false则在显示屏上显示“Game Over!”并终止程序。</p><p>在BlueFi执行该示例程序前，能猜测出执行效果吗？我们能看到屏幕上显示“Game Over!”?</p><p>现在将示例程序编译并下载到BlueFi开源板上，观察该示例程序的运行效果与你所猜测的效果一样？</p><hr><p>我们为BlueFi设计的Python解释器默认使用彩色LCD作为字符控制台，用于输出Python解释器的状态，以及执行脚本语句“print()”时的信息输出。<br>现在双击BlueFi开源板的复位按钮，然后将Python解释器拖放到“BLUEFIBOOT”磁盘，将BlueFi恢复到运行Python脚本的状态。每次BlueFi上电或复位时，<br>你首先在LCD屏幕上左上角看到CIRCUITPYTHON的Logo——蟒蛇图案，当解释器开始执行“<a target="_blank" rel="noopener" href="http://code.py">code.py</a>”脚本程序前会在屏幕上显示“<a target="_blank" rel="noopener" href="http://code.py">code.py</a> output:”提示信息。</p><p>换句话说，在Python解释器的状态允许我们直接使用“print(info)”输出数值或文本信息到BlueFi的LCD显示器。如果我们需要在LCD上显示基本图形或其他形式的信息，<br>那就需要相关的Python库或自建Python代码来实现。我们先让BlueFi的Python解释器运行下面的示例代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-keyword">import</span> time<br>from hiibot_bluefi.screen <span class="hljs-keyword">import</span> Screen<br>from hiibot_bluefi.sensors <span class="hljs-keyword">import</span> Sensors<br><span class="hljs-meta"># import Circle, and Circle classes from adafruit_display_shapes</span><br>from adafruit_display_shapes.circle <span class="hljs-keyword">import</span> Circle<br>from adafruit_display_shapes.line <span class="hljs-keyword">import</span> Line<br><span class="hljs-keyword">import</span> displayio<br><br><span class="hljs-meta"># instantiate Screen, and Sensors classes</span><br>screen = Screen()<br>sensors = Sensors()<br><br><span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> a group of graphic element to draw a backgroud pattern, <span class="hljs-meta-keyword">include</span> 9 elements</span><br>bluefi_group = displayio.Group(max_size=<span class="hljs-number">9</span>)<br><span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> 9 graphic elements</span><br>x_line = Line(<span class="hljs-number">0</span>, <span class="hljs-number">120</span>, <span class="hljs-number">240</span>, <span class="hljs-number">120</span>, color=screen.WHITE)<br>y_line = Line(<span class="hljs-number">120</span>, <span class="hljs-number">0</span>, <span class="hljs-number">120</span>, <span class="hljs-number">240</span>, color=screen.WHITE)<br>outer1_circle = Circle(<span class="hljs-number">120</span>, <span class="hljs-number">120</span>, <span class="hljs-number">119</span>, outline=screen.RED)<br>outer2_circle = Circle(<span class="hljs-number">120</span>, <span class="hljs-number">120</span>, <span class="hljs-number">90</span>, outline=screen.YELLOW)<br>middle_circle = Circle(<span class="hljs-number">120</span>, <span class="hljs-number">120</span>, <span class="hljs-number">70</span>, outline=screen.GREEN)<br>inner2_circle = Circle(<span class="hljs-number">120</span>, <span class="hljs-number">120</span>, <span class="hljs-number">50</span>, outline=screen.CYAN)<br>inner1_circle = Circle(<span class="hljs-number">120</span>, <span class="hljs-number">120</span>, <span class="hljs-number">30</span>, outline=screen.BLUE)<br>inner0_circle = Circle(<span class="hljs-number">120</span>, <span class="hljs-number">120</span>, <span class="hljs-number">12</span>, outline=screen.VIOLET)<br><span class="hljs-meta"># append 9 graphic elements into the group of graphic element</span><br>bluefi_group.append(x_line)<br>bluefi_group.append(y_line)<br>bluefi_group.append(outer1_circle)<br>bluefi_group.append(outer2_circle)<br>bluefi_group.append(middle_circle)<br>bluefi_group.append(inner2_circle)<br>bluefi_group.append(inner1_circle)<br>bluefi_group.append(inner0_circle)<br><br><span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> a group of graphic element to draw a foregroud pattern, a bubble</span><br>bubble_group = displayio.Group(max_size=<span class="hljs-number">1</span>)<br><span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> this bubble, its x-, and y- coordinate equal to x, and y of sensors.acceleration</span><br>x, y, _ = sensors.acceleration<br>level_bubble = Circle(<span class="hljs-keyword">int</span>(x + <span class="hljs-number">120</span>), <span class="hljs-keyword">int</span>(y + <span class="hljs-number">120</span>), <span class="hljs-number">9</span>, fill=screen.WHITE, outline=screen.WHITE)<br><span class="hljs-meta"># append this bubble into graphic element</span><br>bubble_group.append(level_bubble)<br><span class="hljs-meta"># append this graphic element into the group </span><br>bluefi_group.append(bubble_group)<br><span class="hljs-meta"># show this group of graphic element on the screen</span><br>screen.show(bluefi_group)<br><br><span class="hljs-keyword">while</span> True:<br>    <span class="hljs-meta"># update the bubble position on the screen according to sensors.acceleration</span><br>    x, y, _ = sensors.acceleration<br>    bubble_group.y = <span class="hljs-keyword">int</span>(x * <span class="hljs-number">12</span>)<br>    bubble_group.x = <span class="hljs-keyword">int</span>(y * <span class="hljs-number">-12</span>)<br>    time.sleep(<span class="hljs-number">0.05</span>)<br></code></pre></td></tr></table></figure><p>用文本编辑器或MU编辑器，复制上述代码覆盖“/CIRCUITPY/code.py”文件中的全部代码，你将会看到一种水平仪的模拟效果，<br>显示屏上有多个彩色圆代表水平仪刻度，并用一个白色填充圆代表“气泡”。<br>倾斜BlueFi板时BlueFi的LCD显示屏上的“气泡”的位置会随之改变，晃动BlueFi板时“气泡”也会随之晃动。</p><p>为什么会有这样显示效果呢？尤其是，为什么气泡位置的改变时不会影响其他元素的完整显示呢？<br>该示例程序的前6行分别导入Screen、Sensors、displayio类模块，以及绘制圆和直线的Circle和Line类模块，<br>并将Screen和Sensors分别实例化为screen和sensors，使用screen和sensors可以访问BlueFi的显示屏和传感器。<br>在第14行语句中定义名叫bluefi_group的图形元素组(displayio.Group)且包含9个元素，其后的几行语句分别定义2条白色直线和6个彩色的圆形，<br>调用“bluefi_group.append(element)”将定义好的这8个图形元素添加到bluefi_group的图形元素组中；然后再绘制一个白色填充圆<br>代表气泡，这个圆的中心坐标由BlueFi的加速度传感器的x和y分量来确定，最后将图形元素组显示到LCD屏幕上。<br>主循环程序中，读取加速度传感器的x和y分量，然后更新“气泡”的中心坐标。</p><p>这个示例程序中用到的Python库，displayio是BlueFi的Python解释器内建的模块，只需要导入即可使用，使用这个Python模块的接口，<br>将我们需要在LCD屏幕上显示的若干文本信息、几何图形等分层设计和控制，甚至可以在BlueFi的LCD屏幕上实现动画效果，改变某个显示元素的位置时不会影响其他元素的完整性。譬如，<br>冒泡排序算法的可视化 [4]_ ，程序代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> displayio<br>from adafruit_display_shapes.rect <span class="hljs-keyword">import</span> Rect<br>from adafruit_display_shapes.circle <span class="hljs-keyword">import</span> Circle<br>from hiibot_bluefi.screen <span class="hljs-keyword">import</span> Screen<br>screen = Screen()<br>speed = <span class="hljs-number">0.1</span> <span class="hljs-meta"># seconds for changing animation</span><br>height = [random.randint(<span class="hljs-number">10</span> , <span class="hljs-number">100</span>)  <span class="hljs-keyword">for</span> _ in range(<span class="hljs-number">7</span>)]<br>gol = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]          <span class="hljs-meta"># list of the index of group elements</span><br>x = [<span class="hljs-number">26</span>, <span class="hljs-number">58</span>, <span class="hljs-number">90</span>, <span class="hljs-number">122</span>, <span class="hljs-number">154</span>, <span class="hljs-number">186</span>, <span class="hljs-number">218</span>] <span class="hljs-meta"># list of x-coordinate for each sprite</span><br><span class="hljs-meta">#  creat a group of sprites (5x rects)</span><br>group = displayio.Group(max_size=<span class="hljs-number">9</span>)<br><span class="hljs-meta">#  draw each sprite (5x rects)</span><br>s0 = &#123;&#x27;x&#x27;:x[0] , &#x27;y&#x27;:150-height[0] , &#x27;x2&#x27;:20 , &#x27;y2&#x27;:height[0] , &#x27;ot&#x27;:(0, 52, 255) , &#x27;fl&#x27;:(0, 26, 255)&#125;<br>S0 = Rect(s0[&#x27;x&#x27;] , s0[&#x27;y&#x27;] , s0[&#x27;x2&#x27;] , s0[&#x27;y2&#x27;] , outline = s0[&#x27;ot&#x27;] , fill = s0[&#x27;fl&#x27;])<br>group.append(S0)<br>s1 = &#123;&#x27;x&#x27;:x[1] , &#x27;y&#x27;:150-height[1] , &#x27;x2&#x27;:20 , &#x27;y2&#x27;:height[1] , &#x27;ot&#x27;:(255, 0, 0) , &#x27;fl&#x27;:(255, 0, 0)&#125;<br>S1 = Rect(s1[&#x27;x&#x27;] , s1[&#x27;y&#x27;] , s1[&#x27;x2&#x27;] , s1[&#x27;y2&#x27;] , outline = s1[&#x27;ot&#x27;] , fill = s1[&#x27;fl&#x27;])<br>group.append(S1)<br>s2 = &#123;&#x27;x&#x27;:x[2] , &#x27;y&#x27;:150-height[2] , &#x27;x2&#x27;:20 , &#x27;y2&#x27;:height[2] , &#x27;ot&#x27;:(212, 255, 0) , &#x27;fl&#x27;:(212, 255, 0)&#125;<br>S2 = Rect(s2[&#x27;x&#x27;] , s2[&#x27;y&#x27;] , s2[&#x27;x2&#x27;] , s2[&#x27;y2&#x27;] , outline = s2[&#x27;ot&#x27;] , fill = s2[&#x27;fl&#x27;])<br>group.append(S2)<br>s3 = &#123;&#x27;x&#x27;:x[3] , &#x27;y&#x27;:150-height[3] , &#x27;x2&#x27;:20 , &#x27;y2&#x27;:height[3] , &#x27;ot&#x27;:(63, 255, 0) , &#x27;fl&#x27;:(63, 255, 0)&#125;<br>S3 = Rect(s3[&#x27;x&#x27;] , s3[&#x27;y&#x27;] , s3[&#x27;x2&#x27;] , s3[&#x27;y2&#x27;] , outline = s3[&#x27;ot&#x27;] , fill = s3[&#x27;fl&#x27;])<br>group.append(S3)<br>s4 = &#123;&#x27;x&#x27;:x[4] , &#x27;y&#x27;:150-height[4] , &#x27;x2&#x27;:20 , &#x27;y2&#x27;:height[4] , &#x27;ot&#x27;:(0, 216, 255) , &#x27;fl&#x27;:(0, 216, 255)&#125;<br>S4 = Rect(s4[&#x27;x&#x27;] , s4[&#x27;y&#x27;] , s4[&#x27;x2&#x27;] , s4[&#x27;y2&#x27;] , outline = s4[&#x27;ot&#x27;] , fill = s4[&#x27;fl&#x27;])<br>group.append(S4)<br>s5 = &#123;&#x27;x&#x27;:x[5] , &#x27;y&#x27;:150-height[5] , &#x27;x2&#x27;:20 , &#x27;y2&#x27;:height[5] , &#x27;ot&#x27;:(255, 0, 255) , &#x27;fl&#x27;:(255, 0, 255)&#125;<br>S5 = Rect(s5[&#x27;x&#x27;] , s5[&#x27;y&#x27;] , s5[&#x27;x2&#x27;] , s5[&#x27;y2&#x27;] , outline = s5[&#x27;ot&#x27;] , fill = s5[&#x27;fl&#x27;])<br>group.append(S5)<br>s6 = &#123;&#x27;x&#x27;:x[6] , &#x27;y&#x27;:150-height[6] , &#x27;x2&#x27;:20 , &#x27;y2&#x27;:height[6] , &#x27;ot&#x27;:(255, 216, 0) , &#x27;fl&#x27;:(255, 216, 0)&#125;<br>S6 = Rect(s6[&#x27;x&#x27;] , s6[&#x27;y&#x27;] , s6[&#x27;x2&#x27;] , s6[&#x27;y2&#x27;] , outline = s6[&#x27;ot&#x27;] , fill = s6[&#x27;fl&#x27;])<br>group.append(S6)<br><span class="hljs-meta">#  draw a red dot to mark the current minimum</span><br>red_dot = Circle( <span class="hljs-number">36</span>, <span class="hljs-number">170</span>, <span class="hljs-number">5</span>, outline=(<span class="hljs-number">255</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>), fill=(<span class="hljs-number">255</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>) )<br>group.append(red_dot)<br>white_dot = Circle( <span class="hljs-number">66</span>, <span class="hljs-number">170</span>, <span class="hljs-number">5</span>, outline=(<span class="hljs-number">127</span>,<span class="hljs-number">127</span>,<span class="hljs-number">127</span>), fill=(<span class="hljs-number">127</span>,<span class="hljs-number">127</span>,<span class="hljs-number">127</span>) )<br>group.append(white_dot)<br><span class="hljs-meta">#  show thoese sprites onto BlueFi LCD screen</span><br>screen.show(group)<br><br><span class="hljs-meta">#  changing animation</span><br>def animation_chg(l, r, steps):<br>    global group<br>    <span class="hljs-keyword">for</span> _ in range( <span class="hljs-number">8</span> ):<br>        time.sleep(speed)<br>        group[l].x += <span class="hljs-number">4</span>*steps<br>        group[r].x -= <span class="hljs-number">4</span>*steps<br>        <span class="hljs-meta">#time.sleep(speed)</span><br><br><span class="hljs-meta">#  no-change animation</span><br>def animation_nochg(l, r):<br>    global group<br>    tf = group[l].fill<br>    <span class="hljs-keyword">for</span> _ in range(<span class="hljs-number">2</span>):<br>        time.sleep(speed)<br>        group[l].y -= <span class="hljs-number">40</span><br>        time.sleep(speed)<br>        group[l].y += <span class="hljs-number">40</span><br>        <span class="hljs-meta">#time.sleep(speed/4)</span><br>    group[l].fill = tf<br><br><span class="hljs-meta"># sort and its animation</span><br><span class="hljs-keyword">for</span> i in range(<span class="hljs-number">7</span>):<br>    red_dot.x = x[i]+<span class="hljs-number">4</span><br>    time.sleep(<span class="hljs-number">0.1</span>)<br>    <span class="hljs-keyword">for</span> j in range(i+<span class="hljs-number">1</span>, <span class="hljs-number">7</span>):<br>        time.sleep(<span class="hljs-number">0.1</span>)<br>        white_dot.x = x[j]+<span class="hljs-number">4</span><br>        time.sleep(<span class="hljs-number">0.1</span>)<br>        <span class="hljs-keyword">if</span> height[i] &gt; height[j]:<br>            # Exchange their positions, <span class="hljs-keyword">and</span> exchange the index of group elements<br>            c1, c2 = height[j], gol[j]<br>            height[j], gol[j] = height[i], gol[i]<br>            height[i], gol[i] = c1, c2<br>            animation_chg(gol[j], gol[i], j-i)<br>        <span class="hljs-keyword">else</span>:<br>            animation_nochg(gol[j], gol[i])<br><br><span class="hljs-keyword">while</span> True:<br>    pass<br><br></code></pre></td></tr></table></figure><p>这个冒泡排序算法的动画效果显示，将7个彩色方块根据高度升序排列到屏幕上。程序仍使用displayio模块的接口将7个随机高度的方块和2个原点看作是图形元素组中的基本图形元素，<br>初始状态7个方块的颜色和高度都是随机生成的，高度是无序的，然后使用冒泡算法按他们的高度进行升序排列，当前正在比较和交换的两个方块的下方各用一个圆点来指示，<br>交换过程的动画由方块的x坐标分量逐渐增加/减小来实现。</p><p>通过这个示例，我们不仅掌握如何使用Python语言控制BlueFi的显示屏显示图案和动画，还能帮助我们理解冒泡排序算法本身。你能修改上面代码来改变动画的速度吗？</p><hr><p>虽然SPI通讯接口的数据传输速度远高于I2C，而且接口的硬件实现较简单，但SPI通讯接口规范中并没有指定具体的通讯协议，反而允许主机端配置SCK的时钟频率、位序(MSBFIRST/LSBFIRST)、数据线采样模式等，<br>因此SPI通讯接口协议存在较大差异，每一种SPI接口外设几乎都需要根据其接口协议订制接口软件，本节仅以SPI接口的彩色LCD显示器为例演示SPI主机模式的接口实现和应用示例。</p><hr><p>参考文献：<br>::</p><p>[1] <a target="_blank" rel="noopener" href="https://pdf1.alldatasheetcn.com/datasheet-pdf/view/1132511/SITRONIX/ST7789V.html">https://pdf1.alldatasheetcn.com/datasheet-pdf/view/1132511/SITRONIX/ST7789V.html</a><br>[2] <a target="_blank" rel="noopener" href="https://www.arduino.cc/en/Reference/SPI">https://www.arduino.cc/en/Reference/SPI</a><br>[3] <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Conway's_Game_of_Life">https://en.wikipedia.org/wiki/Conway’s_Game_of_Life</a><br>[4] <a target="_blank" rel="noopener" href="https://python4bluefi.readthedocs.io/zh_CN/latest/bluefi_tutorials/advance/bubble_sort_algorithm.html">https://python4bluefi.readthedocs.io/zh_CN/latest/bluefi_tutorials/advance/bubble_sort_algorithm.html</a></p><h1 id="6-3-SPI从机模式">===========================<br>6.3 SPI从机模式<a class="header-anchor" href="#6-3-SPI从机模式"></a></h1><p>MCU片上SPI通讯接口单元工作在从机模式的应用场景往往是双MCU或多MCU系统中，与普通的双核或多核处理器(Multi-Core Processor)组成的系统完全不同。<br>多核处理器一般是指一颗CPU IC由多个内核组成，多核处理器的内核一般采用对等结构，使用片上高速总线互联，多个对等的内核都是总线的Master，由总线仲裁器管理他们对总线的访问，<br>多核并行处理同一个任务的指令序列，仅仅是加速事务处理的速度。多MCU系统中，允许多种体系架构CPU内核(或许是多核的结构)，不同体系架构的多MCU系统是异构系统，<br>每一个CPU内核需要单独编程(异构系统内的CPU指令集不同)。</p><p>… Note:: 多核处理器和多处理器系统</p><ul><li><strong>多核处理器</strong> (Multi-Core Processor)，A multi-core processor is a computer processor integrated circuit with two or more separate processing units, called cores, each of which reads and executes program instructions, as if the computer had several processors</li><li><strong>多处理器系统</strong> (Multi-Processor system)，It is the use of two or more central processing units (CPUs) within a single computer system. The term also refers to the ability of a system to support more than one processor or the ability to allocate tasks between them</li></ul><p>主从多处理器系统(Master/Slave Multi-Processor system)是高性能嵌入式系统常用的架构，主MCU作为系统的主控制器，从MCU仅负责系统的特定任务，<br>譬如网络访问或视频信号处理等任务，允许主从MCU完全不同(包括时钟速度、指令架构等)，两个MCU通过共享总线或私有总线、共享内存等方式建立通讯通路。<br>BlueFi开源板是一种典型的主从多处理器系统，主控制器采用nRF52840，从控制器采用ESP32，主从控制器之间采用SPI通讯接口互联，如图6.14所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-17-48.jpg" alt="SPI2021-08-04-20-17-48"></p><p>图6.14 BlueFi的双MCU结构</p><p>两个MCU之间使用标准4线的SPI通讯接口之外还增加2个额外的控制信号(或称握手信号)，一个是从MCU的复位控制信号，另一个从MCU的忙/空闲状态信号。<br>BlueFi开源板使用这种双处理器协作系统，可以将WiFi联网、TCP/IP协议栈等网络事务与其他事务分开，主处理器只需要通过SPI通讯接口向网络协处理器发送网络处理指令，<br>譬如扫描周围热点(Scan AP)、连接指定热点、连接指定域名的Web服务器等，网络协处理器根据指令及指令参数执行网络事务并通过SPI通讯接口返回执行结果。<br>这就好比我们使用手机/电脑WiFi访问某个网站的过程，首先打开WiFi配置窗口查看周围热点，连接指定的热点，当WiFi连接到某个AP之后，打开浏览器并输入网址，<br>即可查看该网页信息。当我们在手机/电脑上使用浏览器打开指定网址的过程中，虽然浏览器首先使用DNS(域名解析系统)获取指定网址的IP地址，<br>然后使用TCP连接这个IP地址的服务器(还包含默认的TCP端口80)，发送HTTP请求，最后接收HTTP报文格式的网页信息并显示在浏览器上，我们所感知的只是打开一个网页，<br>并不关心DNS、TCP连接和HTTP传输等细节。</p><p>下面先用一个示例来演示BlueFi开源板的这种双处理器系统架构的益处。运行示例之前，需要做些准备工作，首先点击下面链接下载本节内容用到的BlueFi的WiFi BSP源文件：</p><p>. :download:<code>BlueFi_WiFi_eSPI开源库 &lt;../_static/dl_files/bluefi_ch6_3/Bluefi_WiFi_eSPI.zip&gt;</code></p><p>下载后将压缩文件解压到“…/Documents/Arduino/libraries/”文件夹中，子文件夹“BlueFi_WiFi_eSPI”是主控制器nRF52840通过SPI通讯接口访问网络协处理器的BSP源文件。<br>本节内容所更新的BlueFi开源板的BSP源文件包的链接如下，请先删除“…/Documents/Arduino/libraries/BlueFi”文件夹中的全部文件，然后下载下面的压缩文件包，<br>并解压到“…/Documents/Arduino/libraries/”文件夹中，</p><p>. :download:<code>本节内容所用到的BlueFi的BSP源文件 &lt;../_static/dl_files/bluefi_ch6_3/BlueFi_bsp_ch6_3.zip&gt;</code></p><p>准备工作并未完毕！以我们使用WiFi联网的经验，必须配置网络协处理器能够连接到某个可用的WiFi热点(AP)。我们的BSP源文件使用一个独立的仅有两行代码的.h文件保存AP名称和密码。<br>使用文本编辑器修改并保存“…/Documents/Arduino/libraries/BlueFi_WiFi_eSPI/scr/secrets_wifi.h”文件：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SECRET_SSID <span class="hljs-meta-string">&quot;your_AP_name&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SECRET_PASS <span class="hljs-meta-string">&quot;your_AP_password&quot;</span></span><br></code></pre></td></tr></table></figure><p>第1行双引号内输入你可用的WiFi AP名称代替原来的字符串，第2行双引号内输出这个WiFi AP的密码代替原来的字符串。</p><p>然后使用Arduino IDE编辑下面的示例代码，编译并下载到已与你电脑USB相连接BlueFi开源板上。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;BlueFi.h&gt;</span></span><br>String hostName = <span class="hljs-string">&quot;www.zjut.edu.cn&quot;</span>; <span class="hljs-comment">// Specify IP address or hostname</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>&#123;<br>  bluefi.begin();<br>  <span class="hljs-keyword">while</span> (!Serial) &#123;<br>    ; <span class="hljs-comment">// wait for serial port to connect. Needed for native USB port only</span><br>  &#125;<br>  connectWiFi(<span class="hljs-literal">true</span>); <span class="hljs-comment">// see BlueFi_WiFi.h</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>&#123;<br>  Serial.print(<span class="hljs-string">&quot;Pinging &quot;</span>); Serial.print(hostName); Serial.print(<span class="hljs-string">&quot;: &quot;</span>);<br>  <span class="hljs-keyword">int16_t</span> pingResult = WiFi.ping(hostName);<br>  <span class="hljs-keyword">if</span> (pingResult &gt;= <span class="hljs-number">0</span>) &#123;<br>    Serial.print(<span class="hljs-string">&quot;SUCCESS! RTT = &quot;</span>); Serial.print(pingResult); Serial.println(<span class="hljs-string">&quot; ms&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    Serial.print(<span class="hljs-string">&quot;FAILED! Error code: &quot;</span>); Serial.println(pingResult);<br>  &#125;<br>  delay(<span class="hljs-number">5000</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>当BlueFi执行上面示例期间，点击Arduino IDE菜单栏的“工具–&gt;串口监视器”，打开窗口控制台，将在控制台窗口看到以下信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plain"><br>Check WiFi Coprocessor<br>WiFi Coprocessor firmware: 1.3.0<br>Attempting to connect to AP with SSID: your_AP_name<br>.. <br>Connected to wifi<br>SSID: your_AP_name<br>IP Address: 192.168.4.120<br>signal strength (RSSI):-46 dBm<br>Pinging www.zjut.edu.cn: SUCCESS! RTT &#x3D; 10 ms<br>Pinging www.zjut.edu.cn: SUCCESS! RTT &#x3D; 0 ms<br>Pinging www.zjut.edu.cn: SUCCESS! RTT &#x3D; 10 ms<br>Pinging www.zjut.edu.cn: SUCCESS! RTT &#x3D; 10 ms<br></code></pre></td></tr></table></figure><p>你或许在其他地方使用过“ping”命令来测试某个网址或网络设备的物理连通性和网络可达性，控制台输出的最后几行信息正是我们的示例程序执行“ping <a target="_blank" rel="noopener" href="http://www.zjut.edu.cn">www.zjut.edu.cn</a>”网址的结果，<br>控制台的前几行提示信息分别是检查网络协处理器及其版本、连接到指定WiFi AP的信息、连接成功后本机IP地址的信息等。</p><p>在上面示例程序中，第9行语句“connectWiFi(true)”将“…/Documents/Arduino/libraries/BlueFi_WiFi_eSPI/scr/secrets_wifi.h”文件中的AP名称和密码发送给网络协处理器，<br>协处理器自动连接指定的AP，并通过控制台给出提示(即前4行的提示信息)，一旦连接上之后就给出已连接的AP名称和AP为BlueFi分配的IP地址。<br>第14行语句“ WiFi.ping(hostName)”将目标网址字符串“hostName”(即“<a target="_blank" rel="noopener" href="http://www.zjut.edu.cn">www.zjut.edu.cn</a>”)通过SPI通讯接口发送给网络协处理器，<br>网络协处理器立即执行“ping <a target="_blank" rel="noopener" href="http://www.zjut.edu.cn">www.zjut.edu.cn</a>”命令并返回结果。</p><p>“ping”命令是常用的一种网路测试工具，他是基于TCP/IP协议栈的网络层ICMP(Internet Control Message Protocol)协议来实现的。很显然，<br>上述示例的程序中，主控制器仅仅通过SPI通讯接口将字符串“hostName”和“ping”命令发送给网络协处理器，具体的“ping”命令执行过程则有网络协处理器独立完成，<br>查看“…/Documents/Arduino/libraries/BlueFi_WiFi_eSPI/scr/”文件夹中的WiFi接口，你会发现这个WiFi的接口源文件中并没有涉及TCP/IP协议栈等。<br>这里的主控制器所使用的WiFi接口完全兼容Arduino开源平台的WiFi接口库，页面 [1]_ 有这个WiFi接口库的详细说明和参考示例。</p><p>当你把前面的的BSP源文件下载并解压到指定文件夹后，我们已经为BlueFi主控制器准备好完整的WiFi联网接口，包括网络配置、TCP/IP应用层的客户端(client)、<br>服务器端(server)、HTTP和UDP报文收发等接口。基于这些接口，我们只需要通过对主控制器编程即可实现Web访问和应用程序等。</p><p>那么，网络协处理器的固件是如何实现的呢？我们的协处理器采用上海乐鑫的Xtensa体系架构的WiFi SoC——ESP32，其固件是从“Arduino NINA-W102 firmware”移植过来的，<br>固件的源码、编译工具、编译过程等详见 [2]_ 链接及其说明。</p><p>在网络协处理器的固件源码中，你将会发现“lwIP”(开源TCP/IP协议栈)和“freeRTOS”(开源RTOS)等被使用。当然这个ESP32的SPI通讯接口工作在从机模式，<br>我们也能找到该接口的源码实现，即“…/nina-fw/arduino/libraries/SPIS/src/”文件夹的“SPIS.h”和“SPIS.cpp”两个源文件。<br>在“SPIS.h”和“SPIS.cpp”两个源文件中有该SPI通讯接口所使用的SPI端口号、I/O引脚及其配置等初始化接口“begin()”，<br>“transfer(uint8_t out[], uint8_t in[], size_t len)”是SPI从模式关键接口，即双向数据传输的实现。<br>除了第三方开源库(TCP/IP协议栈、RTOS等)、SPI通讯接口(从机模式数据传输接口)之外，协处理器固件的核心工作是SPI通讯接口的命令解析和处理，<br>即接收、解析主控制器发送过来的命令和参数，然后执行该命令并给以应答。</p><hr><p>在Python环境如何使用网络协处理器呢？这需要使用主控制器的WiFi接口的Python模块，包含“/CIRCUITPY/lib/hiibot_bluefi/wifi.py”主接口模块文件，<br>以及“/CIRCUITPY/lib/adafruit_esp32spi/adafruit_esp32spi.py”模块，请打开页面链接 [3]_ 并根据页面说明下载最新版的BlueFi开源板的Python库文件，<br>下载并解压后将“…/lib/hiibot_bluefi/”和“…/lib/adafruit_esp32spi/”两个文件夹复制到CIRCUITPY磁盘的“/lib/”文件夹中，<br>我们就可以正常使用BlueFi开源板的WiFi接口编写Python代码实现网络处理。譬如，下面示例使用WiFi的“scan_networks()”接口扫描周围WiFi热点。<br>该功能的示例代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><br>from hiibot_bluefi.wifi <span class="hljs-keyword">import</span> WIFI<br>wifi = WIFI()<br><br><span class="hljs-keyword">if</span> wifi.esp.status != <span class="hljs-number">0xFF</span>:<br>    print(<span class="hljs-string">&quot;ESP32 be found and in idle mode&quot;</span>)<br><br>print(<span class="hljs-string">&quot;MAC addr:&quot;</span>, [hex(i) <span class="hljs-keyword">for</span> i in wifi.esp.MAC_address])<br><br><span class="hljs-keyword">for</span> ap in wifi.esp.scan_networks():<br>    print(<span class="hljs-string">&quot;\t%s  RSSI: %d&quot;</span> % (str(ap[<span class="hljs-string">&quot;ssid&quot;</span>], <span class="hljs-string">&quot;utf-8&quot;</span>), ap[<span class="hljs-string">&quot;rssi&quot;</span>]))<br><br><span class="hljs-meta"># turn the power of WIFI to save power! this is very importent</span><br>wifi.esp.reset()<br>print(<span class="hljs-string">&quot;Program Done!&quot;</span>)<br></code></pre></td></tr></table></figure><p>复制这些代码并覆盖“/CIRCUITPY/code.py”文件，或者将上述代码复制-粘贴到MU编辑器的代码编辑区，并保存到“/CIRCUITPY/code.py”文件即可，<br>打开MU编辑器的串口控制台，将会看到以下提示信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plain"><br>code.py output:<br>ESP32 be found and in idle mode<br>MAC addr: [&#39;0x10&#39;, &#39;0x7a&#39;, &#39;0x83&#39;, &#39;0x91&#39;, &#39;0x2&#39;, &#39;0x50&#39;]<br>  myTestAP1  RSSI: -46<br>  1402  RSSI: -64<br>  myTestAP2  RSSI: -65<br>  myPrinter  RSSI: -67<br>  AP_40BFE4_4G  RSSI: -68<br>  wlKeJiYuan  RSSI: -70<br>  alldone1  RSSI: -75<br>  TP-LINK_505F  RSSI: -76<br>Program Done!<br></code></pre></td></tr></table></figure><p>具体的WiFi热点名称和信号强度(RSSI)与周边的WiFi环境有关，上述提示仅作参考。<br>在上面的示例程序中，前两行代码分别是导入WIFI模块及其实例化；第4行和第5行代码分别检查网络协处理器的有效性及错误提示；<br>第7行代码将网络协处理器WiFi接口的MAC地址打印出来；第9行和第10行首先执行热点扫描(wifi.esp.scan_networks()接口将返回一个AP列表)，<br>然后将AP的名称和信号强度打印到屏幕(或串口控制台)；最后两行程序分别将网络协处理器复位(降低系统功耗)和程序终止提示。</p><p>接下来我们编写Python代码控制网络协处理器联网，并使用NTP(Network Time Protocol)获取当地的网络时间，然后用BlueFi设计一个简易的电子表功能。<br>具体的实现代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">import</span> time, rtc<br><span class="hljs-keyword">from</span> hiibot_bluefi.wifi <span class="hljs-keyword">import</span> WIFI<br>wifi = WIFI()<br><span class="hljs-comment">######### 1. connect to a AP #########</span><br><span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> wifi.esp.is_connected:<br>    <span class="hljs-keyword">try</span>:<br>        wifi.wifi.connect()<br>        <span class="hljs-comment">#wifi.esp.connect_AP(b&quot;your_ap_name&quot;, b&quot;your_ap_password&quot;)</span><br>    <span class="hljs-keyword">except</span> RuntimeError <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;could not connect to AP, retrying: &quot;</span>, e)<br>        <span class="hljs-keyword">continue</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to&quot;</span>, <span class="hljs-built_in">str</span>(wifi.wifi.ssid, <span class="hljs-string">&quot;utf-8&quot;</span>), <span class="hljs-string">&quot;\tRSSI: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(wifi.wifi.signal_strength) )<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;My IP address is &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(wifi.wifi.ip_address()))<br><span class="hljs-comment">######### 2. Get Local Date&amp;Time with NTP #########</span><br>weekDayAbbr = [<span class="hljs-string">&#x27;Mon&#x27;</span>, <span class="hljs-string">&#x27;Tue&#x27;</span>, <span class="hljs-string">&#x27;Wed&#x27;</span>, <span class="hljs-string">&#x27;Thu&#x27;</span>, <span class="hljs-string">&#x27;Fri&#x27;</span>, <span class="hljs-string">&#x27;Sat&#x27;</span>, <span class="hljs-string">&#x27;Sun&#x27;</span>]<br>TIME_API = <span class="hljs-string">&quot;http://worldtimeapi.org/api/ip&quot;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;get local time from NTP (&quot;</span>, TIME_API, <span class="hljs-string">&quot;) through WiFi device on the BlueFi&quot;</span>)<br>the_rtc = rtc.RTC()<br>response = <span class="hljs-literal">None</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Fetching json from&quot;</span>, TIME_API)<br>        response = wifi.wifi.get(TIME_API)<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">except</span> (ValueError, RuntimeError) <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to get data, retrying\n&quot;</span>, e)<br>        <span class="hljs-keyword">continue</span><br><span class="hljs-comment">######### 3. Close WiFi Co-Processor #########</span><br><span class="hljs-keyword">if</span> wifi.esp.is_connected:<br>    wifi.esp.reset()<br><span class="hljs-comment">######### 4. Parse Date&amp;Time from JSON #########</span><br>json = response.json()<br><span class="hljs-built_in">print</span>(json)  <span class="hljs-comment"># print all message</span><br>current_time = json[<span class="hljs-string">&quot;datetime&quot;</span>]<br>the_date, the_time = current_time.split(<span class="hljs-string">&quot;T&quot;</span>)<br><span class="hljs-built_in">print</span>(the_date)<br>year, month, mday = [<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> the_date.split(<span class="hljs-string">&quot;-&quot;</span>)]<br>the_time = the_time.split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">0</span>]<br><span class="hljs-built_in">print</span>(the_time)<br>hours, minutes, seconds = [<span class="hljs-built_in">int</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> the_time.split(<span class="hljs-string">&quot;:&quot;</span>)]<br><span class="hljs-comment"># We can also fill in these extra nice things</span><br>year_day = json[<span class="hljs-string">&quot;day_of_year&quot;</span>]<br>week_day = json[<span class="hljs-string">&quot;day_of_week&quot;</span>]<br><span class="hljs-comment"># Daylight Saving Time (夏令时)?</span><br>is_dst = json[<span class="hljs-string">&quot;dst&quot;</span>] <br>now = time.struct_time(<br>    (year, month, mday, hours, minutes, seconds+<span class="hljs-number">1</span>, week_day, year_day, is_dst) )<br>the_rtc.datetime = now<br><span class="hljs-comment">######### 5. Show Date&amp;Time on the LCD Screen #########</span><br><span class="hljs-keyword">from</span> hiibot_bluefi.screen <span class="hljs-keyword">import</span> Screen<br>screen = Screen.simple_text_display( <br>                    title_scale=<span class="hljs-number">3</span>, title_color=Screen.RED, title=<span class="hljs-string">&quot;bluefi&quot;</span>, <br>                    text_scale=<span class="hljs-number">3</span>, colors=(Screen.WHITE,) )<br>screen[<span class="hljs-number">1</span>].text = <span class="hljs-string">&quot;Time&quot;</span><br>screen[<span class="hljs-number">1</span>].color = Screen.MAGENTA<br>screen[<span class="hljs-number">2</span>].text = <span class="hljs-string">&quot;Week&quot;</span><br>screen[<span class="hljs-number">2</span>].color = Screen.GREEN<br>screen[<span class="hljs-number">3</span>].text = <span class="hljs-string">&quot;Date&quot;</span><br>screen[<span class="hljs-number">3</span>].color = Screen.BLUE<br>screen.show()<br><span class="hljs-comment">######### 6. Update Date&amp;Time on the LCD Screen #########</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    the_date=<span class="hljs-string">&quot;  &#123;&#125;-&#123;&#125;-&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<br>      the_rtc.datetime.tm_year,  the_rtc.datetime.tm_mon,  the_rtc.datetime.tm_mday, )<br>    screen[<span class="hljs-number">3</span>].text = the_date<br>    the_week=weekDayAbbr[the_rtc.datetime.tm_wday]<br>    screen[<span class="hljs-number">2</span>].text = <span class="hljs-string">&quot;     &quot;</span> +the_week<br>    the_time=<span class="hljs-string">&quot;  &#123;&#125;:&#123;&#125;:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<br>      the_rtc.datetime.tm_hour, the_rtc.datetime.tm_min, the_rtc.datetime.tm_sec, )<br>    screen[<span class="hljs-number">1</span>].text = the_time<br></code></pre></td></tr></table></figure><p>在执行这个示例程序之前，仍需要配置连接指定WiFi热点的名称和密码，与Arduino开源平台的思路一致，这些配置信息保存在一个文本文件中，<br>即“/CIRCUITPY/secrets.py”，将该文件的“ssid”和“password”两项的值分别修改为你可用的WiFi热点名称和密码并保存。<br>然后将上面的示例代码保存到“/CIRCUITPY/code.py”文件，BlueFi执行该程序时会提示是否正确地连接到WiFi热点，是否正确滴获取网络时间，<br>最后在BlueFi的LCD屏幕上显示出日期、时间等信息。</p><p>根据注释语句，我们可以清晰地看到整个示例程序分为6个步骤：控制网络协处理器连接到WiFi热点；使用NTP服务获取本地日期和时间信息；<br>关闭WiFi以节约功耗；解析NTP服务返回的JSON格式信息获取当前的年月日和时分秒信息，并使用这些信息更新本地RTC(日历时钟)单元；<br>将当前日期和时间信息显示在LCD屏幕指定位置；在主循环中读取本地RTC单元获取最新的日期和时间并更新屏幕显示。</p><p>前面的4步仅是为了联网获取本地日期时间并校准本地RTC单元，最后两步才是电子表的设计和实现。这样示例程序在没有使用备用电池的情况下，<br>每次开机首先联网获取当前时间校准RTC，然后在进入电子表模式。</p><hr><p>本节给出一种双处理器系统设计，两个处理器使用SPI通讯接口实现协作事务处理。本节的协处理器是用于处理WiFi联网和网络处理，<br>网络协处理器的固件需要单独编程，与主机通讯接口的SP单元工作在从机模式，负责从SPI端口接收并解析主控制器发出的命令及其参数，<br>网络协处理器执行完毕后仍通过SPI通讯接口向主控制器发出应答信息。</p><p>SPI通讯接口支持多从机共享通讯总线，根据本节的示例我们很容易实现多处理器系统，只是主控制器需要开销更多个I/O引脚用于从机片选信号、<br>主从握手信号等。异构型多处理器系统(不同体系架构的MCU组成的系统)能够以较低的成本实现多种事务协作处理，而且具有极高的灵活性，<br>源于协处理器的可编程特性。</p><hr><p>参考文献：<br>::</p><p>[1] <a target="_blank" rel="noopener" href="https://www.arduino.cc/en/Reference/WiFiNINA">https://www.arduino.cc/en/Reference/WiFiNINA</a><br>[2] <a target="_blank" rel="noopener" href="https://github.com/adafruit/nina-fw">https://github.com/adafruit/nina-fw</a><br>[3] <a target="_blank" rel="noopener" href="https://python4bluefi.readthedocs.io/zh_CN/latest/bluefi_lib/index_lib.html">https://python4bluefi.readthedocs.io/zh_CN/latest/bluefi_lib/index_lib.html</a></p><h1 id="6-4-SPI接口应用设计">===========================<br>6.4 SPI接口应用设计<a class="header-anchor" href="#6-4-SPI接口应用设计"></a></h1><p>SPI通讯接口的扩展常用于高速的或大数据容量的功能外设拓展，譬如WiFi、Ethernet、SD/TF卡、大容量高速数据存储器等。与I2C通讯接口相比，<br>虽然SPI通讯接口的拓扑需要占用更多个I/O引脚用于片选或握手信号，但SPI接口的时钟频率远高于I2C。此外，SPI通讯接口支持全双工通讯，但I2C是半双工的。<br>我们直到SD/TF卡的存储器容量可以按千兆字节(即GB)来计量，而NOR结构型FlashROM的存储容量仅以MB计量，两者的存取速度相差很大(后者速度更快)，<br>而且这两类存储器都采用SPI或QSPI等接口。大容量存储器不使用I2C通讯接口的另一个原因是，I2C的总线寻址和大容量存储器的地址管理会造成数据存取过程中地址信息的传输将占用大量时间，<br>数据的存取效率极地。</p><p>某些小容量的存储器既有I2C接口的也有SPI的，譬如MRFRAM(Magnetic Relaxor Ferroelectric RAM, 磁性弛豫铁电RAM)，FRAM的容量仅有128B~512KB范围。<br>这种存储器既有普通SRAM一样的存取速度和读写寿命(达万亿次)，又有普通FlashROM一样的不挥发性(即断电后数据仍能保持数十年不丢失)。FRAM常用于记录系统运行时的关键数据信息，<br>即使没有后备电池系统突然断电也不必担心这些数据会丢失，而且在系统运行期间将数据写入FRAM操作的时间与RAM一样地快。譬如航空航天器控制系统内的数据采集和记录单元，<br>当数据采集和记录的频次较高时(如每秒1K次)，使用普通FlashROM记录数据的写入速度无法满足要求，使用普通RAM记录数据如果突遇断电会丢失(未转移的)部分数据，<br>FRAM能更好地满足此类需求。绝大多数FRAM产品都支持I2C或SPI通讯接口，I2C接口的时钟频率最高可达1MHz，而SPI接口的时钟频率达20MHz。<br>我们该选择那种接口，需要根据使用FRAM类小容量存储器的目的和数据存取速度、频率来确定。</p><p>除了同步时钟频率外，基于SPI通讯接口的功能能外设扩展设计还需要考虑其他一些因素，如外设工作电压、逻辑电平转换、握手信号的有效电平和默认状态等。<br>当SPI接口的外设工作电压、接口逻辑电平电压与主控制器I/O引脚的逻辑电平向匹配时，这些问题都非常简单，标准SPI通讯接口的SCK、MOSI和MISO都采用推挽型驱动电路，<br>SPI外设的这些信号引脚直接与总线对应连接即可。当逻辑电平电压不匹配时，电平转换电路单元是接口设计中不可缺的，由于SPI总线的信号方向都是单向的，<br>单向的和三态的电平转换IC非常多，OnSemi(安森美)、TI、NXP(或安世)等都有电平转换产品系列可选用。接口功能方面，握手信号与SPI接口的片选信号相似，<br>使用主控制器的低速I/O引脚即可，当然逻辑电平电压的匹配也是需要考虑的，外设的片选信号的默认状态应该设为无效电平，握手信号也应按功能选择合适的默认电平状态，<br>即系统复位后或接口未激活时的电平状态，一般使用上拉或下拉电阻来设置。</p><hr><p>现在我们以硬件TCP/IP协议栈单元的扩展为例来说明SPI接口的通用扩展方法。硬件协议栈，顾名思义就是使用纯数字电路硬件实现TCP/IP协议。对于存储容量小、<br>计算能力弱的MCU来说，硬件协议栈是实现IoT应用的最佳方案。前一节的双处理器系统的网络协处理器也有相似的作用，WiFi网络协处理器需要单独编程，<br>使用软件结合WiFi MAC和PHY等硬件单元实现TCP/IP全栈功能。本节使用WIZnet的W5500硬件TCP/IP协议栈 [1]_ ，采用标准SPI通讯接口与BlueFi金手指拓展接口的P13~P16引脚连接，<br>进而与BlueFi的主控制器——nRF52840实现主从通讯，为BlueFi拓展有线的Ethernet(以太网)功能接口。我们将在后续的内容中使用Ethernet接口，<br>本节使用SPI通讯接口拓展的硬件TCP/IP协议栈不仅是一种SPI接口设计示例，也是一种Ethernet功能接口拓展方法。</p><p>硬件TCP/IP协议栈W5500的内部结构如图6.15所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-18-49.jpg" alt="SPI2021-08-04-20-18-49"></p><p>图6.15 硬件TCP/IP协议栈——W5500的内部结构(来自WIZnet)</p><p>TCP/IP协议栈的实现是W5500的核心，包含一个100BT的Ethernet PHY单元，外围只需一个网络隔离变压器和RJ45插座(或者使用内置网络隔离变压器的RJ45插座)即可让系统接入Ethernet网络；<br>PHY通过标准的MII(介质无关的接口)与MAC层(数据链路层的关键协议，确保数据报文的可靠性和完整性)连接，网络层(包含IP、ARP和PPPoE等)、传输层(TCP和UDP等)等通过内部总线与下层协议单元相连接。<br>W5500内部有一个32KB的Ethernet接收/发送缓存，主控制器可通过SPI通讯接口发送偏移地址访问这些缓存(即读写TCP/IP协议报文)。<br>使用W5500扩展Ethernet功能接口的信号连接如图6.16所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-17-56.jpg" alt="SPI2021-08-04-20-17-56"></p><p>图6.16 BlueFi拓展Ethernet功能接口的信号连接</p><p>具体的电路原理图如图6.17所示。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-18-24.jpg" alt="SPI2021-08-04-20-18-24"></p><p>图6.17 使用BlueFi金手指拓展W5500的电路原理图</p><p>上图的左半部分是RJ45(内置网络隔离变压器)插座、BlueFi金手指拓展接口插座的电路原理，右半部分则是W5500及其外围的基本电路，<br>W5500共有5个信号连接到BlueFi金手指拓展接口上，包括4个标准SPI通讯接口信号和一个中断请求信号。根据W5500的数据页(Datasheet)所列的电气接口信息，<br>建议其工作电压和I/O接口逻辑电压为3.3V，正好与BlueFi的主控制器I/O逻辑电压一致，所以W5500的这些接口信号可以与BlueFi金手指拓展接口信号直连，<br>并使用BlueFi金手指的3.3V电源输出为其供电，注意W5500的最大消耗电流约150mA。</p><p>W5500需要外置的25MHz晶体振荡器为其内部PLL单元提供低频时钟信号，其内部PHY单元的工作模式是通过3个引脚PHY_M2/M1/M0的逻辑电平的组合配置，<br>上图中使用一个简表列举常用配置，这3个配置引脚内部带有上拉电阻，即默认为自动协商模式。W5500的片选信号和中断请求信号都设置有上拉电阻，<br>当这个Ethernet功能接口未与主控制器连接时，即使接口信号都为悬空状态，W5500默认是未被选择的状态，即空闲状态。</p><p>W5500支持的SPI通讯接口协议如图6.18所示。完全兼容标准SPI通讯接口以字节整数倍来传输数据，且每一次传输数据至少4个字节，包含2字节的地址信息、<br>1字节的控制字和至少1字节的数据。数据域的传输方向和模式由控制字的低3位来指定。W5500的数据传输模式分为4种，数据域个数可变的模式，或固定为1/2/4个字节的模式。</p><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-19-04.jpg" alt="SPI2021-08-04-20-19-04"></p><p>图6.18 W5500支持的SPI通讯接口协议</p><p>根据这个Ethernet功能接口电路原理图，以及WIZnet提供的接口库，我们可以实现其软件接口和Ethernet应用，如Web(HTTP)、e-mail(SMTP和POP3)、FTP等。<br>Arduino开源平台的Ethernet库 [2]_ 支持W5500，或者使用其改进版的库 [3]_ ，基于这些开源库代码在Arduino开源平台上使用这里拓展的Ethernet功能接口是非常容易的。</p><p>Arduino开源平台的Ethernet库的接口及其应用示例参见 [4]_ 。<br>参考Arduino官网的编写自定义开源库的向导 [5]_ 可自行实现Ethernet接口库，或者参考 [6]_ 页面的操作向导安装第三方的开源库。</p><hr><p>上面基于BlueFi金手指拓展的Ethernet功能接口仍可以使用Python脚本编程来实现网络连接。首先将BlueFi插入电脑USB端口，双击BlueFi复位按钮，<br>将BlueFi的Python解释器固件拖放到BLUEFIBOOT磁盘，即可使用Python脚本程序控制BlueFi。</p><p>使用标准Ethernet网线将BlueFi开源板及其Ethernet功能接口连接到可用的以太网内，打开电源，并将下面的示例程序代码保存到“/CIRCUITPY/code.py”文件，<br>给BlueFi开源板通电。示例代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> board<br><span class="hljs-keyword">import</span> busio<br><span class="hljs-keyword">import</span> digitalio<br><span class="hljs-keyword">import</span> adafruit_requests <span class="hljs-keyword">as</span> requests<br><span class="hljs-keyword">from</span> adafruit_wiznet5k.adafruit_wiznet5k <span class="hljs-keyword">import</span> WIZNET5K<br><span class="hljs-keyword">import</span> adafruit_wiznet5k.adafruit_wiznet5k_socket <span class="hljs-keyword">as</span> socket<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Wiznet5k WebClient Test&quot;</span>)<br><br>TEXT_URL = <span class="hljs-string">&quot;http://wifitest.adafruit.com/testwifi/index.html&quot;</span><br>JSON_URL = <span class="hljs-string">&quot;http://api.coindesk.com/v1/bpi/currentprice/USD.json&quot;</span><br><br>cs = digitalio.DigitalInOut(board.P16)<br>spi_bus = busio.SPI(board.P13, MISO=board.P14, MOSI=board.P15)<br><br><span class="hljs-comment"># Initialize ethernet interface with DHCP</span><br>eth = WIZNET5K(spi_bus, cs)<br><br><span class="hljs-comment"># Initialize a requests object with a socket and ethernet interface</span><br>requests.set_socket(socket, eth)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Chip Version:&quot;</span>, eth.chip)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;MAC Address:&quot;</span>, [<span class="hljs-built_in">hex</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> eth.mac_address])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;My IP address is:&quot;</span>, eth.pretty_ip(eth.ip_address))<br><span class="hljs-built_in">print</span>(<br>    <span class="hljs-string">&quot;IP lookup adafruit.com: %s&quot;</span> % eth.pretty_ip(eth.get_host_by_name(<span class="hljs-string">&quot;adafruit.com&quot;</span>))<br>)<br><br><span class="hljs-comment"># eth._debug = True</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Fetching text from&quot;</span>, TEXT_URL)<br>r = requests.get(TEXT_URL)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">40</span>)<br><span class="hljs-built_in">print</span>(r.text)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">40</span>)<br>r.close()<br><br><span class="hljs-built_in">print</span>()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Fetching json from&quot;</span>, JSON_URL)<br>r = requests.get(JSON_URL)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">40</span>)<br><span class="hljs-built_in">print</span>(r.json())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">40</span>)<br>r.close()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Program Done!&quot;</span>)<br></code></pre></td></tr></table></figure><p>如果接入的以太网端口与广域网是连通的，我们将会看到从测试网页抓取到的文本信息。<br>这个示例程序用到3种开源库：requests、WIZNET5K和socket，分别是HTTP请求、W5500的SPI通讯接口和网络套接字，<br>运行该示例程序前请从BlueFi的Python库软件包中复制这三个库文件到“/CIRCUITPY/lib/”文件夹，否则Python解释器会提示错误。</p><p>与WiFi接口不同，Ethernet接口无须特殊配置即可连接到广域网，只要求所连接的网络设备(如路由器)能够连接到广域网。</p><hr><p>参考文献：<br>::</p><p>[1] <a target="_blank" rel="noopener" href="https://www.wiznet.io/product-item/w5500/">https://www.wiznet.io/product-item/w5500/</a><br>[2] <a target="_blank" rel="noopener" href="https://github.com/arduino-libraries/Ethernet">https://github.com/arduino-libraries/Ethernet</a><br>[3] <a target="_blank" rel="noopener" href="https://github.com/sstaub/Ethernet3">https://github.com/sstaub/Ethernet3</a><br>[4] <a target="_blank" rel="noopener" href="https://www.arduino.cc/en/Reference/Ethernet">https://www.arduino.cc/en/Reference/Ethernet</a><br>[5] <a target="_blank" rel="noopener" href="https://www.arduino.cc/en/Hacking/LibraryTutorial">https://www.arduino.cc/en/Hacking/LibraryTutorial</a><br>[6] <a target="_blank" rel="noopener" href="https://www.arduino.cc/en/Guide/Libraries">https://www.arduino.cc/en/Guide/Libraries</a></p><h1 id="6-5-本章总结">===========================<br>6.5 本章总结<a class="header-anchor" href="#6-5-本章总结"></a></h1><p>SPI是一种高速同步通讯接口，也是现代绝大多数MCU片上的一种基本功能单元，虽然仅支持主从通讯模式，但数据传输速度几乎是I2C的1000倍，<br>SPI通讯接口已经成为一种最常用的系统内高速外设拓展接口，包括LCD显示器、SD/TF卡、闪存(FlashROM)、pSRAM(伪静态RAM)、网络等外设。</p><p>SPI通讯接口是一种伪共享通讯总线，共享总线仅有SCK、MISO和MOSI三个信号，但每一个SPI从机必须有惟一的片选信号和一些必要的握手信号，<br>使用SPI接口连接多个从外设时需要开销更多个I/O引脚。</p><p>SPI通讯接口支持全双工数据传输模式，也支持半双工模式，而且半双工模式可以节约一个I/O引脚资源。SPI通讯接口的硬件仅仅是移位寄存器，<br>通讯协议/时序仅规定以8位(单字节)的整数倍的数据传输格式和4种数据线采样模式之外，并没有更多的信息格式规定，<br>这意味着每一种SPI从外设都有自定义的数据格式，因此SPI通讯接口外设没有统一的接口库。</p><p>本章中，我们首先了解SPI通讯接口的电路连接和基本时序/协议，包括总线拓扑、数据线的4种采样模式，并了解多种改进的SPI通讯接口。<br>然后从SPI主机模式和从机模式两种角度了解SPI接口的硬件设计和软件编程，并以SPI接口的LCD显示器和网络协处理器等为例分别说明两种模式的接口。</p><p>通过本章学习，我们初步掌握SPI通讯接口的基本原理、接口设计方法、编程控制及应用。</p><hr><p>本章总结如下：</p><ol><li>SPI通讯接口主机和从机的移位寄存器结构、全双工和半双工连接方式、2种总线拓扑，SPI接口的基本时序、数据线的4种采样模式</li><li>改进的SPI通讯接口，如QSPI、SDIO等</li><li>SPI接口主机的接口设计，基于SPI接口的彩色LCD显示器的软硬件设计</li><li>SPI接口从机的接口设计，基于SPI接口的双处理器系统的软硬件设计，WiFi网络协处理器的编程应用</li><li>SPI接口的系统功能拓展设计及应用，基于SPI通讯接口的硬件TCP/IP协议栈的Ethernet功能拓展</li></ol><h1 id="思考题">===========================<br>思考题<a class="header-anchor" href="#思考题"></a></h1><ol><li>根据图6.1和图6.4，简述SPI通讯接口的主机向从机的0x1234地址单元写入数据0x5678的传输过程。</li><li>根据图6.3所示的两种SPI总线拓扑，分别简述两种总线拓扑的主机访问其中某个从机的过程。</li><li>BlueFi的彩色LCD显示器由240*240个像素组成的点阵显示器，每个像素大小和像素间距大小是固定的，像素和间距越小则显示效果越细腻。<br>下图是5(列)<em>7(行)点阵字符的示意图，请给出“0”～“9”十个数字字符的字模数据(含字符间隔)；当我们需要将这些字符放大2倍(10列</em>14行)、4倍或2n倍显示时，<br>请给出字模放大算法。</li></ol><p><img src="/img/load.webp" data-lazy-src="https://image.wxydejoy.top/img/SPI2021-08-04-20-19-20.jpg" alt="SPI2021-08-04-20-19-20"></p><ol start="4"><li>图形LCD显示器不仅可以显示几何图形、字符，也可以显示汉字等象形文字。假设使用16*16点阵(含字间距)显示单个汉字，请给出自己名字的汉字字模数据，<br>并使用BlueFi将这些汉字显示在LCD屏幕上。</li><li>请列举多处理器系统的优缺点。</li><li>使用搜索引擎查阅FRAM存储器MB85RS16的Datasheet，并列举其他半导体公司的同类存储器。如果BlueFi需要使用此类存储器保存关键数据，<br>请以BlueFi金手指拓展接口设计该存储器的软硬件接口。</li></ol></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>SPI接口及其应用</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://theembeddedsystem.readthedocs.io/en/latest/">https://theembeddedsystem.readthedocs.io/en/latest/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>Wang ZF (CME-ZJUT)</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2021-08-04</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2021-09-11</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://image.wxydejoy.top/img/SPI2021-08-04-20-14-21.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/c58d/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/wxydejoy/image//img/jxsj/202106/25/165002%20image-20210625165002595.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">微机考试大纲</div></div></a></div><div class="next-post pull-right"><a href="/posts/218/"><img class="next-cover" src="https://image.wxydejoy.top/img/202108/05/180940%20spi_master_slave_structure_4wires.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">I2C接口及其应用</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC6%E7%AB%A0-SPI%E6%8E%A5%E5%8F%A3%E5%8F%8A%E5%85%B6%E5%BA%94%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 第6章 SPI接口及其应用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-1-SPI%E9%80%9A%E8%AE%AF%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.</span> <span class="toc-text">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 6.1 SPI通讯接口</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-2-SPI%E4%B8%BB%E6%9C%BA%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 6.2 SPI主机模式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-3-SPI%E4%BB%8E%E6%9C%BA%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 6.3 SPI从机模式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-4-SPI%E6%8E%A5%E5%8F%A3%E5%BA%94%E7%94%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.</span> <span class="toc-text">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 6.4 SPI接口应用设计</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-5-%E6%9C%AC%E7%AB%A0%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 6.5 本章总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">7.</span> <span class="toc-text">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 思考题</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background:0 0"><div id="footer-wrap"><div class="copyright">&copy;2021 By wxy</div><div class="footer_custom_text"><p>快看看站长更新了没 !</p><p><img src="/img/foot/ypy.png" style="margin-inline:5px" target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"></p><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src="/img/foot/hexo.png" title="博客框架为Hexo"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src="/img/foot/butterfly.png" title="主题采用butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://www.jsdelivr.com/"><img src="/img/foot/jsdeliver.png" title="本站使用JsDelivr为静态资源提供CDN加速"></a></p><p><img src="https://cdn.jsdelivr.net/gh/wxydejoy/image@master/img/202107/15/181743%20%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" style="margin-inline:5px"><a style="margin-inline:5px" target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010602011871">浙公网安备 33010602011871号</a> <a style="margin-inline:5px" target="_blank" href="http://beian.miit.gov.cn/">浙ICP备2021022005号</a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://cnmd.vercel.app/',
      region: 'ap-shanghai'
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'https://cnmd.vercel.app/',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://cnmd.vercel.app/',
        region: 'ap-shanghai',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script defer data-pjax src="/js/forbidIE.js"></script><script async src="/js/diytitle.js"></script><script data-pjax async src="/js/scroll.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '#demo-teriminal',
  '#demo-editor',
  "#posts-chart",
  "#tags-chart",
  "#categories-chart",
  "#categories-radar",
  "#posts-calendar",
  '#web_bg',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="app-refresh" id="app-refresh" style="position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease"><div class="app-refresh-wrap" style="display:flex;color:#fff;height:100%;align-items:center;justify-content:center"><label>✨收到来自快乐星球的信号👉</label><a href="javascript:void(0)" onclick="location.reload()"><span style="color:#fff;text-decoration:underline;cursor:pointer">🛰查看🛰</span></a></div></div><script>if ('serviceWorker' in navigator) {
if (navigator.serviceWorker.controller) {
navigator.serviceWorker.addEventListener('controllerchange', function() {
showNotification()
})
}
window.addEventListener('load', function() {
navigator.serviceWorker.register('/sw.js')
})
}
function showNotification() {
if (GLOBAL_CONFIG.Snackbar) {
var snackbarBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
GLOBAL_CONFIG.Snackbar.bgLight :
GLOBAL_CONFIG.Snackbar.bgDark
var snackbarPos = GLOBAL_CONFIG.Snackbar.position
Snackbar.show({
text: '✨收到来自快乐星球的信号👉',
backgroundColor: snackbarBg,
duration: 500000,
pos: snackbarPos,
actionText: '🛰查看🛰',
actionTextColor: '#fff',
onActionClick: function(e) {
location.assign('https://wxydejoy.top/random/')
},
})
} else {
var showBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
'#49b1f5' :
'#1f1f1f'
var cssText = `top: 0; background: ${showBg};`
document.getElementById('app-refresh').style.cssText = cssText
}
}</script><div id="SAO-back"><div id="SAO-menu"><div id="SAO-menu-content"><div class="utils-list"><div class="utils-list-item"><div class="user-panel" style="top:undefined"><div class="user-panel-name">关于</div><div class="user-panel-img"><img src="/img/icon/android-chrome-192x192.png"></div><div class="user-panel-properties">点击进入!</div></div><i class="fas fa-question-circle" onclick='clickAudio(),setTimeout(function(){SAOclose(),linkStart("/about/")},500)'></i></div><div class="utils-list-item"><div class="user-panel" style="top:undefined"><div class="user-panel-name">关于</div><div class="user-panel-img"><img src="/img/icon/android-chrome-192x192.png"></div><div class="user-panel-properties">点击进入!</div></div><i class="fas fa-question-circle" onclick='clickAudio(),setTimeout(function(){SAOclose(),linkStart("/about/")},500)'></i></div><div class="utils-list-item"><div class="user-panel"><div class="user-panel-name">Instructions</div><div class="user-panel-img"><img src="/img/icon/android-chrome-192x192.png"></div><div class="user-panel-properties"><h4>欢迎来访</h4><center>-wxy</center></div></div><i class="fa fa-cog" onclick="panelAudio(),UtilsClick()"></i></div><div class="utils-list-item"><i class="fa fa-power-off" onclick="clickAudio(),SAOclose()"></i></div></div></div></div></div><div id="SAO-logout"><div class="logout-title">Alert</div><div class="logout-alert">是否确认退出?</div><div class="logout-button"><span class="logout-confirm"><button class="far fa-circle" type="button" name="confirm" onclick="clickAudio(),confirmLogout()"></button></span><span class="logout-cancel"><button class="fa fa-times" type="button" name="cancel" onclick="panelAudio(),cancelLogout()"></button></span></div></div><script async src="/js/SAO_Menu.js"></script></div><script>var fdata={apiurl:"https://friendapi.vercel.app/api",initnumber:10,stepnumber:10};localStorage.setItem("fdatalist",JSON.stringify(fdata))</script><script defer src="https://cdn.jsdelivr.net/npm/hexo-filter-fcircle/assets/js/fetch.min.js"></script><script data-pjax>function butterfly_swiper_injector_config(){var s=document.getElementById("recent-posts");console.log("已挂载butterfly_swiper"),s.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="posts/c90a/" alt=""><img width="48" height="48" src="https://image.wxydejoy.top/img/每日打卡日记2021-08-21-17-55-10.png" alt=""/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-07-03</span><a class="blog-slider__title" href="posts/c90a/" alt="">每日打卡日记</a><div class="blog-slider__text">每日打卡日记</div><a class="blog-slider__button" href="posts/c90a/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="posts/bc41/" alt=""><img width="48" height="48" src="https://image.wxydejoy.top/img/202107/24/201851%20image-20210724201844799webp" alt=""/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-07-24</span><a class="blog-slider__title" href="posts/bc41/" alt="">看板罗小黑-Live2d</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="posts/bc41/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="posts/c6bd/" alt=""><img width="48" height="48" src="https://image.wxydejoy.top/img/202107/21/143225%20image-20210721143225266.png" alt=""/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-07-21</span><a class="blog-slider__title" href="posts/c6bd/" alt="">Icosahedron-Geometry 背景</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="posts/c6bd/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}document.getElementById("recent-posts")&&"/"===location.pathname&&butterfly_swiper_injector_config()</script><script defer src="https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__slideInUp"),arr[i].setAttribute("data-wow-duration","1s"),arr[i].setAttribute("data-wow-delay","0s"),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("post-title"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__backInUp"),arr[i].setAttribute("data-wow-duration","0.7"),arr[i].setAttribute("data-wow-delay","0ms"),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("flink-item-icon"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__tada"),arr[i].setAttribute("data-wow-duration","1s"),arr[i].setAttribute("data-wow-delay","1s"),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","5")</script><script async>for(var arr=document.getElementsByClassName("flink-item-name"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__heartBeat"),arr[i].setAttribute("data-wow-duration","1s"),arr[i].setAttribute("data-wow-delay","1s"),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","5")</script><script async>for(var arr=document.getElementsByClassName("flink-item-desc"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__heartBeat"),arr[i].setAttribute("data-wow-duration","1s"),arr[i].setAttribute("data-wow-delay","1s"),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","5")</script></div><script defer src="https://cdn.jsdelivr.net/gh/graingert/wow@1.3.0/dist/wow.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-butterfly-wowjs/lib/wow_init.min.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{scale:.8,hHeadPos:.5,vHeadPos:.618,jsonPath:"/live2dw/assets/luoxiaohei.model.json"},display:{position:"right",width:250,height:400,superSample:2,hOffset:20,vOffset:-140},mobile:{show:!1,scale:.5},react:{opacityDefault:.7,opacityOnHover:.2},log:!1})</script></body></html>